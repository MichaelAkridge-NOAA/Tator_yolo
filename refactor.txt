Refactor Plan (Incremental + Fuzz-Verified)
==========================================

Goal
----
Clean up unused code and refactor the monolithic backend into maintainable
modules without breaking behavior. This will be done incrementally and
validated by a fuzzing/smoke test after *every* change batch.


Part A — Cleanup Strategy (Dead Code)
-------------------------------------
We will not delete code based on “looks unused” alone. Instead we will use a
triple-check approach and *validate every deletion* with tests.

Signals for deletion:
1) Static usage:
   - No route decorator
   - Not called inside module (AST call graph)
   - Not referenced by docs/scripts
2) Runtime behavior:
   - Fuzz test coverage confirms removal does not break key endpoints
3) Optional manual check:
   - Code is not dynamically invoked (e.g. string name lookup)

Deletion happens in small batches (20–40 functions) so we can isolate errors.


Part B — Refactor Target Structure
----------------------------------

tator/
  api/
    prepass.py
    calibration.py
    datasets.py
    detectors.py
    classifiers.py
    qwen.py
    sam3.py
    jobs.py
    headgraft.py
  services/
    prepass.py
    calibration.py
    detectors.py
    sam3.py
    qwen.py
    classifier.py
    dataset_manager.py
    recipes.py
    model_registry.py
  models/
    schemas.py
    jobs.py
    recipes.py
  storage/
    datasets.py
    cache.py
    jobs.py
  utils/
    io.py
    image.py
    logging.py
    labels.py

The legacy localinferenceapi.py remains as a shim that just attaches routers.


Part C — Incremental Fuzz/Smoke Validation Plan (Required)
----------------------------------------------------------
We replace the “week of logging” approach with *incremental fuzzing*.
Every change batch must pass fuzz tests *before moving on*.

Principles:
1) Each batch is small (single feature or a small file extraction).
2) After every batch, run a targeted fuzz/smoke test suite.
3) Keep a rolling “minimal test pack” that executes in ~1–3 minutes.
4) If tests fail, revert or fix immediately (no piling up broken work).

Test tiers:
  Tier 0 (smoke): request/response validation on core endpoints
  Tier 1 (fuzz lite): randomized but bounded inputs for prepass & calibration
  Tier 2 (fuzz deep): optional full pipeline with real sample images

We run Tier 0 + Tier 1 on *every batch*.
Tier 2 is run after larger milestones.


Part D — Fuzz Pack Specification
-------------------------------
Create a minimal, deterministic test pack with:
- 2–4 small sample images
- a tiny labelmap
- 1 detector config, 1 classifier config, 1 SAM3 config
- 1 glossary with 3–5 classes

Fuzz steps:
1) Start API
2) Validate /datasets, /models, /glossary endpoints
3) Run a single prepass with tiny max_images
4) Run calibration with cached prepass
5) Run captioning (single image)
6) Run detector run with both full-frame + windowed
7) Confirm results are schema-valid and non-empty

All fuzz runs should:
- enforce deterministic random seeds
- run under tight timeouts (fail fast)
- produce a single structured JSON summary for regression comparison


Part E — Safe Refactor Order (each step fuzzed)
-----------------------------------------------
1) Extract utils/ (image, labels, io) → run Tier 0/1 fuzz
2) Extract prepass services → fuzz
3) Extract calibration services → fuzz
4) Extract detector registry + inference → fuzz
5) Extract classifier registry + inference → fuzz
6) Extract SAM3 + Qwen helpers → fuzz
7) Replace route handlers with api/* routers → fuzz
8) Remove unused legacy code → fuzz


Part F — Regression Rules
-------------------------
We do not proceed if:
- Any fuzz test fails
- Any output schema changes unexpectedly
- Any calibration metrics regresses by >2% absolute without explanation

If regression occurs:
- Identify which batch caused it
- Fix immediately or roll back


Outcome
-------
By the end of this sequence:
- localinferenceapi.py is reduced to a router loader
- all core logic lives in services/
- unused code is removed with confidence
- fuzz tests keep behavior stable throughout

Status Snapshot (2026-02-02)
----------------------------
- Stage 1 (utils extraction): complete (see Progress Log + Stage 1 notes).
- Stage 2 (dead code triage): complete; scan tool tuned; 2 deletion batches applied; no further high‑confidence deletions identified.
- Stage 3–7 (services + router split): complete in code; Tier‑0/Tier‑1 (skip‑GPU) validation done; full GPU validation pending.
- Stage 8 (dead code removal): paused (2 batches removed; no further high‑confidence
  deletions after scan). Awaiting deeper analysis or new evidence.
- Stage 9 (validation + docs): docs updates complete; Tier‑0 + Tier‑1 skip‑GPU + Tier‑1 full GPU run complete.
- Stage 10 (cleanup + docs): docstrings + docs updates complete; Tier‑2 fuzz + 10‑image bench completed; caption sanity pending (503).

Validation Backlog (follow‑up)
-------------------------------
- Qwen caption windowed/full sanity checks (real model) — 503 in last attempt.
- Investigate YOLO baseline 500s from 10‑image benchmark run (may require detector config/labelmap alignment or server state).

Recent Validation Runs (2026-02-03)
----------------------------------
- Tier‑0/Tier‑1 API sanity (OpenAPI + UI endpoint map/method checks): complete.
- UI OpenAPI sanity sweep (all non‑mutating endpoints): complete.
- UI endpoint extraction vs OpenAPI (check_ui_endpoints.py): complete (flags dynamic base paths like /{}/active; no real API gaps).
- OpenAPI missing param/query tests: complete.
- Negative upload tests: complete.
- Pytest unit suite (tests/): complete.
- Tier‑0 fuzz script: complete.
- Tier‑1 fuzz script (GPU): complete (after runtime unload / caption reload fix).
- Refactor validation (Tier‑0 + Tier‑1 GPU) complete again after caption device fix.
- UI smoke test (GPU endpoints): complete.
- UI contract tests: complete.
- Qwen prepass smoke (2 images): complete.
- UI data ops tests (glossary + prepass recipe + dataset glossary set/restore): complete.
- Qwen prepass smoke (4 images): complete.
- Qwen prepass benchmark (2 images, prepass-only): complete (summary JSONL + baseline).
- Tier‑1 fuzz skip‑GPU path (run_fuzz_fast.sh SKIP_GPU=1): complete.
- Qwen prepass benchmark (1 image, full pipeline): complete.
- UI OpenAPI sanity sweep re-run: complete.
- Qwen prepass benchmark (5 images, prepass-only): complete.
- Qwen prepass benchmark (3 images, full pipeline): complete.
- Qwen prepass benchmark (10 images, full pipeline): complete.
- UI param sweep (negative payloads, run_ui_param_sweep.py): complete.
- Qwen prepass benchmark (YOLO label-source, 2 images, full pipeline): complete.
- Qwen prepass benchmark (YOLO label-source, 2 images, prepass-only): complete.
- UI concurrency smoke (safe GETs, run_ui_concurrency_smoke.py): complete.
- Calibration job smoke (max_images=5, classifier) complete after fixes to calibration call sites + feature build scripts.
- Calibration pipeline fixes: build_ensemble_features now resolves classifier paths via UPLOAD_ROOT; train_ensemble_xgb import path fixed for direct script execution.
- UI OpenAPI sanity sweep (run_ui_openapi_sanity.py) re-run: complete.
- UI endpoint map + method checks re-run: complete.
- UI param sweep + negative tests re-run: complete.
- UI concurrency smoke + contract tests re-run: complete.
- UI data ops tests (glossary + recipe CRUD + dataset glossary set/restore) re-run: complete.
- UI smoke (GPU endpoints) re-run: complete.
- Tier‑0 fuzz + Tier‑1 fuzz (GPU) re-run: complete.
- OpenAPI missing param sanity: complete.
- OpenAPI missing query sanity: complete.
- UI endpoint discovery (check_ui_endpoints.py): complete; only placeholder paths (/{}/active, /{}/runs, etc.) flagged.
- Refactor validation (SKIP_GPU=1): complete.
- Refactor validation (SKIP_GPU=0): complete.
- Qwen prepass smoke (2 images, seed=123): complete.
- Qwen prepass benchmark (2 images, prepass-only, seed=123): complete.
- UI smoke (GPU endpoints) re-run after RF‑DETR fix: complete (RF‑DETR now returns 200).
- Refactor validation (SKIP_GPU=0) re-run after RF‑DETR device fallback: complete.
- Pytest (tests/ only) re-run after RF‑DETR fix: 51 passed.
- Qwen prepass benchmark (1 image, label-source=yolo, prepass-only): complete.
- Qwen prepass benchmark (1 image, label-source=yolo, full pipeline): complete.
- UI smoke (GPU endpoints) re-run after RF‑DETR device fallback: complete.


Atomic Task List (Executable Roadmap)
-------------------------------------
These are the exact, itemized tasks to perform in order. Each item is a
stand‑alone atomic change with required fuzz/smoke validation afterward.

Testing/Validation Rule for Every Step
- After each step (or step batch), run Tier‑0 + Tier‑1 fuzz.
- Record a regression summary JSON and diff against baseline.
- If any schema changes or metrics regress >2% without explanation: stop, fix,
  re‑run.
- Every step must include a “safety check” line in notes: what could break,
  and how we verified it did not.

Prep / Baseline
1. Create a minimal deterministic “fuzz pack” dataset (2–4 images + tiny
   labelmap + sample glossary) in a new folder under tests/fixtures/.
   - Include: labelmap.txt, glossary.json, 2–4 images, optional labels
   - Keep image sizes small to reduce GPU cost
   - Store a small manifest.json with hashes for images + labelmap + glossary
   - Validate manifest hashes at test start
2. Create Tier‑0 smoke test script:
   - Start/reuse API
   - Hit /health + /datasets + /models + /glossaries
   - Validate schemas and required fields
   - Assert non‑empty fields: datasets=[], models=[], glossaries=[]
   - Ensure API returns 200 and JSON parses under strict schema
3. Create Tier‑1 fuzz‑lite script (must cover all options):
   - Prepass: detectors only (YOLO+RF‑DETR), SAM3 text only, SAM3 similarity only
   - Prepass: windowed SAM3 text ON + similarity ON
   - Prepass: windowed OFF (baseline)
   - Calibration: MLP + XGB on same cache
   - Caption: full‑frame + windowed captioning
   - Detector: full‑frame + SAHI
   - Classifier: batch scoring with full probability vector
   - Ensure both detector models are requested in the same run
   - Ensure glossary hash + text are recorded in cache meta
4. Add regression summary output (JSON):
   - For each step: detections count, class distribution, cache count
   - For calibration: precision/recall/F1
   - Track hashes for glossary/labelmap/recipe
   - Track “pipeline_version” and “config_hash”
   - Track counts per source (yolo/rfdetr/sam3_text/sam3_similarity)
5. Add a runner script:
   - Executes Tier‑0 then Tier‑1
   - Fixed seeds; emits baseline diff report
   - Optional “fast mode” to skip heavy SAM3/Qwen
   - Exits non‑zero if any diff in required fields

Stage Progress Notes (refactor execution log)
---------------------------------------------
- 2026-02-02: Stage 1 prep — added tools/scan_unused_defs.py (heuristic unused
  def scanner; excludes Qwen-Agent/Qwen3-VL/rf-detr/sam3/sahi by default).
  Validation to run later:
  - Tier‑0: run scan on repo root and archive report.
- 2026-02-02: Ran unused‑def scan (heuristic) → /tmp/tator_unused_defs_20260202.txt.
  Validation to run later:
  - Tier‑0: re‑run scan after next extraction batch and diff report.
- 2026-02-02: Updated scan_unused_defs.py to exclude SAM3-UNet for cleaner reports.
- 2026-02-02: Updated scan_unused_defs.py to ignore FastAPI route-decorated
  functions (router.get/post/etc.) so endpoints are not falsely flagged
  as unused. Re-ran scan to /tmp/tator_unused_defs_refactor_stage2.txt.
- 2026-02-02: Updated scan_unused_defs.py to skip dunder methods to reduce
    noise in unused-def reports. Re-ran scan to /tmp/tator_unused_defs_refactor_stage2.txt.
  - 2026-02-02: Updated scan_unused_defs.py to treat @_register_agent_tool
    handlers as indirect uses (same as route handlers) so agent tools are not
    falsely reported as unused.
  - 2026-02-02: Updated scan_unused_defs.py to only record top-level defs
    (skip class methods) to reduce noise when curating deletion batches.
  - 2026-02-02: Updated scan_unused_defs.py to account for import aliasing
    (from x import foo as bar), mapping alias uses back to original names.
  - 2026-02-02: Updated scan_unused_defs.py to exclude tests/ so unused-def
    reports focus on runtime code.
- 2026-02-02: Updated scan_unused_defs.py to ignore nested function defs
  (only top-level module functions are reported) to reduce false positives.
  - 2026-02-02: Updated scan_unused_defs.py to treat attribute access as a use
    (e.g., local._run_qwen_chat_stream) to reduce false positives from module
    attribute invocation.
- 2026-02-02: Re‑ran scan_unused_defs.py (max‑uses=0/1). No defs with zero uses.
  The uses<=1 list is dominated by route handlers/classes; no safe deletions
  identified without deeper analysis. Stage 2 remains closed pending new evidence.
- 2026-02-02: Removed additional Qwen caption helper wrappers
  (_resolve_qwen_variant_model_id, _strip_qwen_model_suffix,
  _caption_glossary_map, _caption_preferred_label) and updated all call sites
  to *_impl variants.
  Validation to run later:
  - Tier‑0: qwen caption prompt assembly (full + windowed)
  - Tier‑1: qwen caption, prepass caption, and qwen_infer path
- 2026-02-02: Extracted FastAPI routes into api/* routers and replaced
  @app.* decorators in localinferenceapi.py with app.include_router(...).
  Validation to run later:
  - Tier‑0: /health, /datasets, /models, /glossaries
  - Tier‑1: prepass, calibration, detector, classifier, caption, sam3, qwen
- 2026-02-02: Removed a batch of thin wrapper functions (hash/dir helpers,
  base64 decode, detector image resolve, SAHI slice, dataset signature/count,
  calibration list/sample/cache/hash, detector clamp utilities, agent recipe
  parse/normalize helpers, SAM3/Qwen device helpers). Updated call sites to
  *_impl variants and injected deps (logger/HTTPException/torch/etc.) where
  needed.
  Validation to run later:
  - Tier‑0: dataset listing/signature, calibration job creation
  - Tier‑1: prepass + calibration, detector runs, sam3 device selection
- 2026-02-02: Removed Qwen caption helper wrappers (collapse/parse/sanitize,
  caption heuristics, window positions/labels/degenerate checks). Call sites
  now use *_impl directly; window size/overlap wrappers retained.
  Validation to run later:
  - Tier‑0: qwen caption parsing + window sizing
  - Tier‑1: qwen caption full + windowed, prepass captioning
- 2026-02-02: Removed Qwen caption window size/overlap wrappers; call sites
  now use _resolve_qwen_window_size_impl/_resolve_qwen_window_overlap_impl with
  explicit defaults. Validation unchanged (caption window sizing).
- 2026-02-02: Deduped duplicate imports from services.qwen in localinferenceapi.py
  to avoid shadowing/confusion. No runtime behavior change expected.
- 2026-02-02: Removed trivial wrappers for _serialize_seg_job,
  _summarize_qwen_metric, and _yolo_head_graft_force_stop. Call sites now use
  *_impl directly. Validation to run later:
  - Tier‑0: segmentation job list/get
  - Tier‑1: Qwen training metrics logging, head‑graft force stop
- 2026-02-02: Removed trivial wrapper _serialize_prompt_helper_job; call sites
  now use _serialize_prompt_helper_job_impl directly. Validation to run later:
  - Tier‑0: prompt helper job list/get
  - Tier‑1: prompt helper run endpoints
- 2026-02-02: Removed prompt helper preset wrappers
  (_list_prompt_helper_presets/_load_prompt_helper_preset/_save_prompt_helper_preset);
  call sites now use *_impl with explicit root/guard args. Validation to run later:
  - Tier‑0: prompt helper preset list/get/create
- 2026-02-02: Removed _list_prepass_recipes wrapper; call site now uses
  _list_prepass_recipes_impl with explicit root/meta. Validation to run later:
  - Tier‑0: prepass recipe list endpoint
- 2026-02-02: Removed _resolve_head_normalize_embeddings wrapper and wired
  callers to _resolve_head_normalize_embeddings_impl. Validation to run later:
  - Tier‑0: classifier head metadata endpoints
- 2026-02-02: Removed _load_labelmap_simple wrapper; _validate_clip_dataset now
  uses _load_labelmap_simple_impl via lambda. Validation to run later:
  - Tier‑0: clip training dataset validation
- 2026-02-02: Removed CLIP registry wrappers
  (_list_clip_classifiers/_resolve_clip_labelmap_path/_find_labelmap_for_classifier/_list_clip_labelmaps).
  Call sites now use *_impl with explicit upload root + labelmap constraints.
  Validation to run later:
  - Tier‑0: clip classifier/labelmap list + download endpoints
- 2026-02-02: Removed _start_calibration_job/_cancel_calibration_job wrappers;
  endpoints now call *_impl with explicit args. Validation to run later:
  - Tier‑0: calibration start/cancel endpoints
- 2026-02-02: Removed _build_backend_for_variant and _format_qwen_load_error
  wrappers; call sites now use *_impl directly. Validation to run later:
  - Tier‑0: SAM3 backend selection
  - Tier‑1: Qwen model load error formatting
- 2026-02-02: Removed dataset metadata wrappers
  (_load_registry_dataset_metadata/_coerce_dataset_metadata/
  _load_qwen_dataset_metadata/_load_sam3_dataset_metadata); call sites now use
  *_impl with explicit meta names + loaders. Validation to run later:
  - Tier‑0: dataset list + metadata endpoints
- 2026-02-02: Removed YOLO/RF‑DETR run list helpers
  (_collect_*_artifacts/_*_metrics_summary/_clean_metric_summary/_list_*_runs);
  endpoints now use *_impl directly. Validation to run later:
  - Tier‑0: run list endpoints
  - Tier‑1: run summary metrics output
- 2026-02-02: Removed _save_yolo_active/_save_rfdetr_active/_load_detector_default/
  _save_detector_default wrappers; endpoints now use *_impl with explicit paths.
  Validation to run later:
  - Tier‑0: detector default + active model endpoints
- 2026-02-02: Removed _detect_yolo_layout wrapper; training dataset resolution
  now uses _detect_yolo_layout_impl directly. Validation to run later:
  - Tier‑1: YOLO/RF‑DETR training dataset resolution
- 2026-02-02: Removed _resolve_dataset_entry wrapper; training dataset resolution
  now uses _resolve_dataset_entry_impl via lambda. Validation to run later:
  - Tier‑1: YOLO/RF‑DETR training dataset resolution
- 2026-02-02: Removed _collect_recipe_assets wrapper; prepass recipe export now
  uses _collect_recipe_assets_impl via lambda. Validation to run later:
  - Tier‑0: prepass recipe export/download
- 2026-02-02: Removed _validate_clip_dataset wrapper; clip training now calls
  _validate_clip_dataset_impl with explicit args. Validation to run later:
  - Tier‑0: clip training validation (CPU-only)
- 2026-02-02: Removed SAM3 run registry wrappers
  (_describe_run_dir/_run_dir_for_request/_delete_run_scope); list/delete/
  promote endpoints now use *_impl directly. Validation to run later:
  - Tier‑0: SAM3 run list/delete/promote endpoints
- 2026-02-02: Removed _yolo_prune_run_dir/_rfdetr_prune_run_dir wrappers;
  call sites now use *_impl directly. Validation to run later:
  - Tier‑1: YOLO/RF‑DETR run pruning (delete endpoints)
- 2026-02-02: Removed _strip_checkpoint_optimizer wrapper; promote flow now
  uses _strip_checkpoint_optimizer_impl directly. Validation to run later:
  - Tier‑1: SAM3 promote run endpoint
- 2026-02-02: Removed _ensure_coco_supercategory wrapper; RF‑DETR dataset
  resolution now calls _ensure_coco_supercategory_impl directly. Validation to run later:
  - Tier‑1: RF‑DETR dataset prep
- 2026-02-02: Removed _find_free_port wrapper; RF‑DETR DDP now uses
  _find_free_port_impl directly. Validation to run later:
  - Tier‑1: RF‑DETR training (distributed setup)
- 2026-02-02: Removed _yolo_load_run_labelmap/_rfdetr_load_labelmap wrappers;
  call sites now use *_impl with explicit loaders. Validation to run later:
  - Tier‑1: head‑graft + RF‑DETR dataset prep
- 2026-02-02: Removed _yolo_resolve_split_paths wrapper; training dataset
  resolution now uses _yolo_resolve_split_paths_impl directly. Validation to run later:
  - Tier‑1: YOLO training dataset resolution
- 2026-02-02: Removed _rfdetr_variant_info wrapper; call sites now use
  _rfdetr_variant_info_impl with explicit variants + HTTPException. Validation to run later:
  - Tier‑1: RF‑DETR training + run summary
- 2026-02-02: Removed _rfdetr_best_checkpoint wrapper; call sites now use
  _rfdetr_best_checkpoint_impl directly. Validation to run later:
  - Tier‑1: RF‑DETR active model selection + training summary
- 2026-02-02: Moved Qwen generation helpers (seq length, vision token
  estimation, logits processors + immediate action bias) into
  services/qwen_generation.py and removed their definitions from
  localinferenceapi.py. localinferenceapi now imports these helpers.
  Validation to run later:
  - Tier‑1: Qwen captioning + prepass caption generation unchanged
  - Tier‑1: Qwen generation logit processors still applied (thinking effort + wait bias)
- 2026-02-02: Removed unused _predict_proba_batched helper from
  services/classifier_batch.py (duplicate of classifier impl). Validation to run later:
  - Tier‑1: classifier batch sizing unchanged
- 2026-02-02: Removed unused glossary helper _normalize_glossary_name from
  utils/glossary.py. Validation to run later:
  - Tier‑1: glossary normalization + labelmap mapping unchanged
- 2026-02-02: Removed unused prompt helper utilities
  (_parse_prompt_candidates, _generate_prompt_text) from services/qwen.py and
  dropped unused imports in localinferenceapi.py. Validation to run later:
  - Tier‑1: prompt expansion path unchanged
- 2026-02-02: Removed unused agent recipe execution-plan import from
  localinferenceapi.py and deleted _normalize_agent_recipe_execution_plan from
  services/prepass_recipes.py. Validation to run later:
  - Tier‑1: agent recipe save/import/export unchanged
- 2026-02-02: Removed unused _predict_proba_batched from services/classifier_batch.py
  (duplicate of classifier implementation) and removed unused glossary helpers
  (_normalize_glossary_name, _glossary_key). Validation to run later:
  - Tier‑1: classifier batch sizing + glossary normalization unchanged
- 2026-02-02: Fixed agent tool registration for sam3_text by moving
  @_register_agent_tool("sam3_text") onto _agent_tool_sam3_text (was incorrectly
  attached to _sam3_text_payloads_from_state). Validation to run later:
  - Tier‑1: sam3_text tool calls resolve correctly via tool registry
- 2026-02-02: Removed unused _agent_tool_prompt_qwen helper after scan confirmed
  it had no call sites. Validation to run later:
  - Tier‑1: Qwen prompt assembly unchanged (no tool prompt wrapper)

Stage 1 — Utilities Extraction
5a. Add tools/scan_unused_defs.py (excludes Qwen-Agent/Qwen3-VL/rf-detr/sam3/sahi by default) to surface likely-unused defs (heuristic, count<=1). Use as a guide for safe deletions.
6. Identify image/label/io helper functions in localinferenceapi.py.
   - Create a mapping table (function name → new module)
7. Move image helpers to utils/image.py (preserve signature).
   - Add unit tests for any non‑trivial helper (resize, tiling, bbox conversion)
8. Move label helpers to utils/labels.py (preserve labelmap behavior).

Stage 1 Mapping Table (draft)
-----------------------------
Image helpers (candidate moves → utils/image.py):
- _decode_image_base64 (wrapper around _decode_image_base64_impl)
- _resolve_detector_image (wrapper around _resolve_detector_image_impl)
- _slice_image_sahi (wrapper around _slice_image_sahi_impl)
- _agent_overlay_base_image (if still used by agent mining flow)

Label helpers (candidate moves → utils/labels.py):
- _apply_expected_labelmap_warnings (if not already in utils)
- _normalize_class_name_for_match (if not already in utils)

IO/helpers (candidate moves → utils/io.py):
- _compute_dataset_signature (if not already in utils)
- _count_dataset_images

Notes:
- Only move wrappers that are pure pass‑through to _impl functions.
- Keep endpoint‑specific error handling in localinferenceapi.py.
- Remaining wrappers (not moved yet) depend on local constants or HTTP error
  translation; keep until later services extraction.
- 2026-02-02: Removed local wrappers for _stable_hash, _compute_dir_signature,
  and _path_is_within_root in localinferenceapi.py; switched call sites to
  *_impl functions from utils. Validation to run later:
  - Tier‑1: dataset signature paths and recipe import/export unchanged.
- 2026-02-02: Removed local _decode_image_base64 wrapper; updated call sites
  to use _decode_image_base64_impl with BASE64_IMAGE_* defaults. Validation:
  - Tier‑1: base64 decode paths (predict_base64, clip uploads) unchanged.
- 2026-02-02: Removed local _resolve_detector_image wrapper; updated detector
  call sites to use _resolve_detector_image_impl with explicit decode + cache
  functions. Validation:
  - Tier‑1: YOLO/RF‑DETR predict_* endpoints unchanged.
- 2026-02-02: Switched SAHI slicing calls to _slice_image_sahi_impl directly.
  Validation:
  - Tier‑1: YOLO/RF‑DETR windowed predictions unchanged.
- 2026-02-02: Removed local _compute_dataset_signature wrapper; switched
  agent recipe persistence to _compute_dataset_signature_impl. Validation:
  - Tier‑1: agent recipe create/export unchanged.
- 2026-02-02: Removed local _count_dataset_images wrapper; updated call site
  to use _count_dataset_images_impl with _iter_yolo_images. Validation:
  - Tier‑1: dataset summary counts unchanged.
- 2026-02-02: Removed local _count_caption_labels wrapper; updated call site
  to use _count_caption_labels_impl. Validation:
  - Tier‑1: dataset summary caption label counts unchanged.
- 2026-02-02: Removed local _dir_size_bytes wrapper; updated call sites to
  _dir_size_bytes_impl. Validation:
  - Tier‑1: cache size endpoints unchanged.
- 2026-02-02: Removed local _compute_labelmap_hash wrapper; updated call site
  to _compute_labelmap_hash_impl. Validation:
  - Tier‑1: agent recipe create/export unchanged.
- 2026-02-02: Removed local agent recipe plan/validation wrappers
  (_parse_agent_recipe_schema_version/_classify_agent_recipe_mode/
  _normalize_agent_recipe_execution_plan/_validate_agent_recipe_structure).
  Validation:
  - Tier‑1: agent recipe import/normalize/validate unchanged.
- 2026-02-02: Removed detector clamp wrappers (_clamp_conf_value/_clamp_iou_value/
  _clamp_max_det_value/_clamp_slice_params) and updated call sites to *_impl.
  Validation:
  - Tier‑1: YOLO/RF‑DETR predict_* warnings unchanged.
- 2026-02-02: Removed calibration helper wrappers
  (_calibration_list_images/_calibration_sample_images/_calibration_cache_image/
  _calibration_hash_payload/_calibration_safe_link). Call sites now use *_impl
  with lambdas for injected deps. Validation:
  - Tier‑1: calibration job list/sampling/cache unchanged.
- 2026-02-02: Removed local _infer_clip_model_from_embedding_dim wrapper; updated
  call sites to _infer_clip_model_from_embedding_dim_impl. Validation:
  - Tier‑1: CLIP classifier load + embedding dim inference unchanged.
- 2026-02-02: Removed local _resolve_sam3_or_qwen_dataset wrapper; updated
  call sites to _resolve_sam3_or_qwen_dataset_impl with injected deps.
  Validation:
  - Tier‑1: dataset resolution for prepass/calibration/exports unchanged.
- 2026-02-02: Removed local _resolve_dataset_legacy wrapper; updated call sites
  to _resolve_dataset_legacy_impl with injected roots + HTTPException.
  Validation:
  - Tier‑1: dataset resolution fallback unchanged.
- 2026-02-02: Removed local Qwen prompt/device wrappers
  (_resolve_qwen_device/_get_qwen_prompt_config/_render_qwen_prompt); updated
  call sites to *_impl with injected config + HTTPException. Validation:
  - Tier‑1: Qwen prompt rendering + device selection unchanged.
- 2026-02-02: Removed local _extract_balanced_json wrapper; updated call site to
  _extract_balanced_json_impl. Validation:
  - Tier‑1: JSON parsing in Qwen inference unchanged.
- 2026-02-02: Removed local _dinov3_resolve_device wrapper; updated call sites
  to _dinov3_resolve_device_impl with cuda_disabled flag injection. Validation:
  - Tier‑1: DINOv3 device routing unchanged.
- 2026-02-02: Removed local _resolve_sam3_device/_resolve_sam3_mining_devices
  wrappers; updated call sites to *_impl with injected device prefs + HTTP error.
  Validation:
  - Tier‑1: SAM3 device selection unchanged.

Stage 2 (cleanup) prep notes
----------------------------
- Initial unused‑def scan includes SAM3-UNet modules; decide whether to exclude
  that directory from future scans or schedule for later cleanup.
- Updated unused‑def scan now ignores FastAPI router-decorated endpoints; current
  output is dominated by localinferenceapi.py helper classes/methods that are
  likely invoked indirectly (runtime caches, SAM3 backends). These need manual
  review before any deletions.
- Manual review of top-level uses=0 functions shows they are agent tool handlers
  invoked via registry (indirect), so no safe deletion batch yet.
- No deletions performed yet; will curate a deletion list from
  /tmp/tator_unused_defs_20260202.txt before first cleanup batch.
- After ignoring agent-tool decorators, scan output now only lists class
  methods on runtime caches (PredictorSlot/PredictorManager). These are
  indirectly used; no safe deletions identified yet.
- Updated scan now flags a short list of imported-but-unused helpers
  (e.g., _normalize_agent_recipe_execution_plan, _parse_prompt_candidates).
  These require manual review before deletion because imports alone can be
  vestigial or staged for future use.
- Scan remains heuristic: attribute access (e.g., local._run_qwen_chat_stream)
  is not counted as a use, so some items in the report are false positives.
  - Current scan output (after cleanup) is limited to attribute-invoked agent
    tool helpers; no further safe deletions identified without manual checks.
- Scan results include class methods (reported as uses=0), so manual filtering
  is required before any deletions.
- 2026-02-02: Re-ran scan_unused_defs.py after cleanup; report now empty
  (no top-level unused defs detected at uses=0).
- 2026-02-02: Generated low-usage report (uses<=1) for manual Stage 2 review:
  /tmp/tator_unused_defs_refactor_stage2_uses1.txt (374 entries). No deletions
  performed yet; requires manual confirmation before removing any defs.
- 2026-02-02: Began Stage 2 triage of uses<=1 list. Early review shows:
  - api/* build_*_router functions are expected single-use (include_router).
  - services/* helpers are typically single-use by design (top-level flow).
  - localinferenceapi.py core classes/backends are single-use or indirect.
  => No safe deletion candidates identified yet. Continue manual review before
     any removals.
- 2026-02-02: Updated scan_unused_defs.py to skip api/* build_*_router helpers
  (expected include_router single-use). New uses<=1 report:
  /tmp/tator_unused_defs_refactor_stage2_uses1.txt (346 entries).
- 2026-02-02: Updated scan_unused_defs.py to skip tools/ scripts to avoid
  false positives from CLI helpers. New uses<=1 report:
  /tmp/tator_unused_defs_refactor_stage2_uses1.txt (292 entries).
- 2026-02-02: Continued triage of uses<=1 list. Majority of remaining entries
  are single-use helpers in services/*, utils/*, and tools/* scripts plus core
  localinferenceapi.py classes/backends. These are expected and not safe to
  delete without deeper behavioral analysis. No deletion batch approved yet.
   - Add tests for labelmap parsing and label alignment
9. Move IO helpers to utils/io.py (no path changes).
   - Add tests for JSON/YAML loading (with json5 fallback)
10. Update imports to use utils/ modules.
11. Run Tier‑0 + Tier‑1 fuzz (check no change in output schema).

Validation Backlog (run when GPUs are free)
-------------------------------------------
- Run tools/run_fuzz_fast.sh (Tier‑0 + Tier‑1 in skip‑GPU mode) — DONE 2026-02-02
- Run tools/run_fuzz_fast.sh with SKIP_GPU=0 (full Tier‑1) — DONE 2026-02-02 (labelmap mismatch warnings expected in fuzz_pack)
- Confirm prepass endpoint responds with same schema (no missing fields)
- Confirm caption endpoint returns full + windowed outputs
- Spot‑check: cluster label counts + overlay summaries unchanged after helper extraction
- Spot‑check: get_tile_context tile_cluster_list + caption_hint unchanged after tile_context refactor
- Spot‑check: prepass window generation (sam3_text + similarity) unchanged after prepass_windows refactor
- Spot‑check: similarity expansion counts unchanged after prepass_similarity refactor
- Spot‑check: background_classes derived from classifier head unchanged after classifier_utils refactor
- Spot‑check: labelmap+glossary loading unchanged after datasets labelmap_meta refactor
- Spot‑check: detector payload fields (bbox_2d/bbox_yolo) unchanged after coords det_payload refactor
- Spot‑check: YOLO/RF‑DETR extract outputs unchanged after services/detectors move
- Spot‑check: detector image cache resolution unchanged after services/detectors move
- Spot‑check: YOLO device arg/p2 scale helpers unchanged after services/detectors move
- Spot‑check: RF‑DETR variant/checkpoint/log helpers unchanged after services/detectors move
- Spot‑check: RF‑DETR metric sanitize + aug policy unchanged after services/detectors move
- Spot‑check: RF‑DETR augmentation install/restore unchanged after services/detectors move
- Spot‑check: RF‑DETR checkpoint epoch helper unchanged after services/detectors move
- Spot‑check: RF‑DETR training monitor loop unchanged after services/detectors move
- Spot‑check: YOLO training helpers unchanged after services/detectors move
- Spot‑check: checkpoint optimizer stripping unchanged after services/detectors move
- Spot‑check: YOLO/RF‑DETR labelmap loaders unchanged after services/detectors move
- Spot‑check: RF‑DETR dataset prep/remap unchanged after services/detectors move
- Spot‑check: base64 image decode unchanged after utils/image move
- Spot‑check: COCO info/write/ensure helpers unchanged after utils/coco move

Validation attempt notes
------------------------
- 2026-02-02: Tried running tools/run_refactor_validation.sh with SKIP_GPU=1
  from the sandbox; Tier‑0 failed with PermissionError (socket/HTTP blocked).
  Validation must be run when network access to 127.0.0.1:8000 is permitted.
- 2026-02-02: Ran tools/run_refactor_validation.sh with SKIP_FUZZ=1 to confirm
  py_compile succeeds without HTTP access.
- 2026-02-02: Ran tools/run_refactor_validation.sh with SKIP_GPU=1 (HTTP allowed).
  Tier‑0 passed; Tier‑1 executed in skip‑GPU mode (steps intentionally skipped).
- 2026-02-02: Ran tools/run_refactor_validation.sh with SKIP_GPU=0.
  Tier‑0 passed; Tier‑1 ran full GPU steps with expected detector labelmap
  mismatch warnings in fuzz_pack. Calibration job started (async).
- 2026-02-02: Ran tools/run_qwen_prepass_smoke.sh (4 images) and
  tools/run_qwen_prepass_benchmark.sh (10 images). YOLO baseline returned 500s.
- 2026-02-02: Caption sanity check via /qwen/caption returned HTTP 503 after
  retries; needs re‑run when Qwen is available.
- 2026-02-03: Re‑ran API smoke checks after fixes.
  - /qwen/caption (full) succeeded with Qwen3‑VL 4B Instruct.
  - /yolo/predict_full now returns labelmap but 0 detections on a
    labeled image (needs investigation; model may be under‑performing).
  - /rfdetr/predict_full now succeeds (74 detections on the same image).
  - /runtime/unload now succeeds (fixed argument mismatch).
  - Added guard: if active YOLO run is the smoke dataset, raise
    yolo_active_smoke_run (prevents silent 0‑detection runs).

Blockers
--------
- Qwen caption sanity check blocked by 503 (service unavailable).
- YOLO baseline 500s during 10‑image benchmark need investigation.
- Spot‑check: path_is_within_root helper unchanged after utils/io move
- Spot‑check: classifier resolve/load wrappers unchanged after refactor import cleanup
- Spot‑check: validate_cuda_device_ids helper unchanged after utils/gpu move
- Spot‑check: COCO validity/segmentation helpers unchanged after utils/coco move
- Spot‑check: YOLO label image lookup unchanged after utils/image move
- Spot‑check: COCO image path/label relpath unchanged after utils/image move
- Spot‑check: Qwen JSONL label extraction unchanged after datasets move
- Spot‑check: YOLO labelmap discovery unchanged after datasets move
- Spot‑check: localinferenceapi import cleanup doesn't alter endpoint behavior (start API, hit /health)
- Spot‑check: glossary library load remains intact after helper pruning
- Spot‑check: prepass grid usage summaries unchanged after grid helper pruning
- Spot‑check: calibration prompt/candidate endpoints still work after metrics helper pruning
- Spot‑check: classifier head tuning endpoints still work after classifier helper pruning
- Spot‑check: import cleanup doesn't alter runtime behavior (basic /health + /datasets endpoints)
- Spot‑check: Tier‑1 fuzz handles classifier-required calibration (skip or include classifier_id)
- Run tools/run_refactor_validation.sh (py_compile + Tier‑0/Tier‑1 skip‑GPU)
- Spot‑check: YOLO→COCO conversion unchanged after datasets move
- Spot‑check: Qwen→COCO conversion unchanged after datasets move
- Spot‑check: COCO→YOLO conversion unchanged after datasets move
- Spot‑check: SAM3 dataset meta resolution unchanged after datasets move
- Spot‑check: COCO index loader unchanged after datasets move
- Spot‑check: prepass recipe import/export unchanged after dead wrapper cleanup
- Spot‑check: COCO path helpers still wired via services after wrapper cleanup
- Spot‑check: labelmap meta helpers wired to datasets impls unchanged after wrapper cleanup
- Spot‑check: agent mining cache/meta roots still enforced after helper cleanup
- Spot‑check: prepass endpoints still route through deep prepass after legacy wrapper cleanup
- Spot‑check: COCO info/segmentation helpers still invoked via services after wrapper cleanup
- Spot‑check: calibration prompt expansion still uses services/qwen after prompt wrapper cleanup
- Spot‑check: Qwen dataset metadata persist still invoked via services/datasets after wrapper cleanup
- Spot‑check: agent mining CLIP backbone still loads via services/clip_runtime after impl cleanup (no missing references)
- Spot‑check: hard-negative replay export UI still behaves (no missing refs) after calibration_metrics cleanup
- Spot‑check: RF‑DETR training rejects invalid device IDs after GPU validation wiring
- Spot‑check: YOLO data.yaml writer unchanged after services/detectors move
- Spot‑check: YOLO variant YAML + detect module helpers unchanged after services/detectors move
- Spot‑check: RF‑DETR DDP worker unchanged after services/detectors move
- Spot‑check: head‑graft audit + force‑stop unchanged after services/detector_jobs move
- Spot‑check: free-port helper unchanged after utils/network move
- Spot‑check: stable hash helper unchanged after utils/hashing move
- Spot‑check: SAM3 synonym expansion outputs unchanged after sam3_synonyms refactor
- Spot‑check: cluster handle mapping unchanged after cluster_handles refactor
- Spot‑check: classifier default selection + labelmap matching unchanged after classifier_select refactor
- Spot‑check: grid tool usage tracking unchanged after prepass_grid usage refactor
- Spot‑check: overlay crop bbox selection unchanged after overlay_tools refactor
- Spot‑check: classifier batch sizing + proba batching unchanged after classifier_batch refactor
- Spot‑check: detector NMS merge outputs unchanged after detector_merge refactor
- Spot‑check: prepass cache meta includes glossary text + hash (new caching safety)
- Spot‑check: prepass cache writes glossary.json alongside prepass.meta.json
- Spot‑check: glossary normalization + labelmap entry normalization unchanged after utils/glossary + utils/labels move
- Spot‑check: labelmap mismatch guard unchanged after utils/labels move
- Spot‑check: window bbox normalization unchanged after utils/coords move
- Spot‑check: recipe meta read/write unchanged after services/prepass_recipes move
- Spot‑check: dataset glossary + qwen labelmap loaders unchanged after services/datasets move
- Spot‑check: qwen dataset signature helpers unchanged after services/datasets move
- Spot‑check: dataset metadata helpers unchanged after services/datasets move
- Spot‑check: qwen dataset metadata load/persist unchanged after services/datasets move
- Spot‑check: sam3 dataset metadata load/persist unchanged after services/datasets move
- Spot‑check: dataset caption counting unchanged after services/datasets move
- Spot‑check: dataset listing unchanged after services/datasets move
- Spot‑check: qwen caption label helpers unchanged after services/qwen move
- Spot‑check: qwen window position helper unchanged after services/qwen move
- Spot‑check: dir_size_bytes unchanged after utils/io move
- Spot‑check: glossary library load/normalize unchanged after services/glossary_library move
- Spot‑check: recipe threshold normalization unchanged after services/prepass_config move
- Spot‑check: SAM3 availability guard unchanged after services/prepass_config move
- Spot‑check: calibration sample/hash/link helpers unchanged after services/calibration_helpers move
- Spot‑check: calibration image listing unchanged after services/calibration_helpers move
- Spot‑check: calibration atomic write unchanged after services/calibration_helpers move
- Spot‑check: calibration job update helper unchanged after services/calibration_helpers move
- Spot‑check: calibration image cache token unchanged after services/calibration_helpers move
- Spot‑check: SAM3 prompt variants unchanged after services/sam3_synonyms move
- Spot‑check: SAM3 cache clearing unchanged after services/sam3_runtime move
- Spot‑check: SAM3 device resolution unchanged after services/sam3_runtime move
- Spot‑check: SAM3 runtime reset unchanged after services/sam3_runtime move
- Spot‑check: SAM3 backend selection unchanged after services/sam3_runtime move
- Spot‑check: SAM3 text runtime load unchanged after services/sam3_runtime move
- Spot‑check: Qwen runtime reset unchanged after services/qwen_runtime move
- Spot‑check: Qwen runtime unload unchanged after services/qwen_runtime move
- Spot‑check: Qwen caption cache eviction unchanged after services/qwen_runtime move
- Spot‑check: Qwen caption runtime loader unchanged after services/qwen_runtime move
- Spot‑check: Qwen variant resolver unchanged after services/qwen move
- Spot‑check: Qwen model suffix handling unchanged after services/qwen move
- Spot‑check: Qwen load error formatting unchanged after services/qwen move
- Spot‑check: Qwen device selection unchanged after services/qwen_runtime move
- Spot‑check: Qwen prompt config get/set unchanged after services/qwen move
- Spot‑check: Qwen prompt rendering unchanged after services/qwen move
- Spot‑check: Qwen JSON block parsing unchanged after services/qwen move
- Spot‑check: Qwen coordinate scaling helpers unchanged after utils/coords move
- Spot‑check: inference runtime unloads unchanged after services/runtime_unload move
- Spot‑check: training runtime prepare/finalize unchanged after services/runtime_unload move
- Spot‑check: DINOv3 device resolution unchanged after services/dinov3_runtime move
- Spot‑check: CLIP backbone suspend/resume unchanged after services/clip_runtime move
- Spot‑check: CLIP mining backbone load unchanged after services/clip_runtime move
- Spot‑check: classifier backbone resume unchanged after services/classifier_runtime move
- Spot‑check: context store/chunk behavior unchanged after services/context_store move
- Spot‑check: overlay view cell/full payloads unchanged after services/overlay_views move
- Spot‑check: tile context payloads unchanged after services/tile_context move
- Spot‑check: readable logging (prepass.readable) unchanged after services/readable move
- Spot‑check: similarity exemplar selection unchanged after services/prepass move
- Spot‑check: deep prepass cleanup unchanged after services/prepass move
- Spot‑check: deep prepass part A unchanged after services/prepass move
- Spot‑check: deep prepass wrapper unchanged after services/prepass move
- Spot‑check: deep prepass caption unchanged after services/prepass move
- Spot‑check: legacy prepass wrapper unchanged after services/prepass move
- Spot‑check: calibration prepass worker unchanged after services/calibration_helpers move
- Spot‑check: qwen caption helper outputs unchanged after services/qwen move
- Spot‑check: qwen text helper outputs unchanged after services/qwen move
- Spot‑check: calibration orchestration unchanged after services/calibration move
- Spot‑check: detector inference outputs unchanged after services/detectors move
- Spot‑check: detector runtime caching unchanged after services/detectors move
- Spot‑check: detector infer state setters unchanged after services/detectors move
- Spot‑check: detector active/default configs unchanged after services/detectors move
- Spot‑check: classifier review + batching outputs unchanged after services/classifier move
- Spot‑check: agent recipe list/delete endpoints unchanged after services/prepass_recipes move
- Spot‑check: agent recipe persist/load/zip endpoints unchanged after services/prepass_recipes move
- Spot‑check: agent recipe import endpoints unchanged after services/prepass_recipes move
- Spot‑check: agent cascade endpoints unchanged after services/agent_cascades move
- Spot‑check: agent cascade import endpoints unchanged after services/agent_cascades move
- Spot‑check: prepass recipe list/delete/import/export endpoints unchanged after services/prepass_recipes move
- Spot‑check: prepass recipe asset export bundle unchanged after services/prepass_recipes move
- Spot‑check: prepass recipe export endpoint unchanged after services/prepass_recipes move
- Spot‑check: prepass recipe CRUD endpoints unchanged after services/prepass_recipes move
- Spot‑check: prompt helper preset endpoints unchanged after services/prompt_helper_presets move
- Spot‑check: prompt helper job serialization unchanged after services/prompt_helper move
- Spot‑check: segmentation job serialization unchanged after services/segmentation move
- Spot‑check: segmentation job log/update unchanged after services/segmentation move
- Spot‑check: qwen training job serialization unchanged after services/qwen_jobs move
- Spot‑check: qwen training GET logging unchanged after services/qwen_jobs move
- Spot‑check: qwen training job log/update unchanged after services/qwen_jobs move
- Spot‑check: qwen training metric append unchanged after services/qwen_jobs move
- Spot‑check: qwen metric coercion unchanged after services/qwen_jobs move
- Spot‑check: qwen metric summary unchanged after services/qwen_jobs move
- Spot‑check: clip training job serialization unchanged after services/classifier_jobs move
- Spot‑check: clip training job logging/update unchanged after services/classifier_jobs move
- Spot‑check: clip training job metric append unchanged after services/classifier_jobs move
- Spot‑check: sam3 training job serialization unchanged after services/sam3_jobs move
- Spot‑check: sam3 training job log/update unchanged after services/sam3_jobs move
- Spot‑check: sam3 run listing unchanged after services/sam3_runs move
- Spot‑check: detector job serialization unchanged after services/detector_jobs move
- Spot‑check: detector job log/update unchanged after services/detector_jobs move
- Spot‑check: head‑graft job log/update unchanged after services/detector_jobs move
- Spot‑check: dataset artifact purge unchanged after services/datasets move
- Spot‑check: Qwen label collection unchanged after services/datasets move
- Spot‑check: YOLO labelmap discovery unchanged after services/datasets move

Stage 2 — Prepass Service Extraction
12. Create services/prepass.py; move prepass pipeline (detectors + SAM3 + dedupe).
13. Create services/prepass_config.py for defaults + validation.
14. Ensure prepass config includes all toggles (windowed, thresholds, detectors).
15. Update API handlers to call services/prepass.py.
16. Run Tier‑0 + Tier‑1 fuzz:
    - Verify cached prepass reuse
    - Verify glossary text is stored in cache meta
    - Verify windowed/non‑windowed match expected counts
    - Verify detector full‑frame + SAHI both included
   - Verify settings from UI propagate to prepass config

Stage 2.5 — Qwen helpers (captioning + prompt expansion)
17. Create services/qwen.py and move Qwen caption helpers + prompt expansion glue.
18. Keep legacy wrappers in localinferenceapi.py to preserve API shape.
19. Run Tier‑0 + Tier‑1 fuzz:
    - Verify captioning full + windowed flows
    - Verify synonym expansion prompt and output parsing
    - Verify labelmap/glossary handling unchanged

   Stage 2 progress notes
   - Moved CalibrationJob dataclass into services/calibration.py and imported into localinferenceapi.
   - Dropped localinferenceapi serialize wrappers for sam3/yolo/rfdetr jobs; endpoints call services.* directly.
   - Dropped localinferenceapi _serialize_job/_serialize_qwen_job wrappers; endpoints call services.* directly.
   - Dropped localinferenceapi _serialize_calibration_job wrapper; endpoints use services.calibration helper directly.
   - Updated requirements.txt SAM3 comment to avoid removed docs reference.
   - scan_unused_defs now returns no module-level candidates (decorated endpoints ignored).
   - Removed stray qwen_agentic_calib_strict_1img.json artifact.
   - Added optional RUN_UNUSED_SCAN=1 flag to tools/run_refactor_validation.sh (documented in tools/README.md).
   - Added module docstring to localinferenceapi.py.
   - Updated tools/README.md with --include-tests flag for scan_unused_defs.
   - Removed docs/_local/*.txt briefs/logs (archived elsewhere).
   - Removed unused load_labelmap/save_yolo_file helpers in tools/detect_missclassifications.py.
   - Removed unused services/glossary_library.py (no references after cleanup).
   - Removed unused GLOSSARY_LIBRARY_* constants in localinferenceapi.py (no references).
   - Documented scan_unused_defs in tools/README.md.
   - Removed unused model.py (standalone CLIP implementation; no imports/references found).
   - scan_unused_defs now skips decorated defs by default; use --include-decorated to scan route handlers.
   - Removed unused imports in tools/detect_missclassifications.py and tools/fuzz_tier1.py (ruff F401).
   - Fixed scan_unused_defs word-boundary counting (counts now show route handlers count=1; ignore decorated endpoints).
   - Removed unused config.py (no imports/references found).
   - Removed unused app/qwen_agent_runtime.py (no references; static scan + grep confirmed).
   - Ran scan_unused_defs (module-level only); flags agent mining + prompt helper + segmentation endpoints as count<=1 (likely only referenced by routes). Keep for manual review in Stage 2.
   - Removed unused qwen_agent.settings import in localinferenceapi (ruff F401).
   - Added module docstrings across utils/* (classifier_utils, coco, coords, datasets, errors, glossary, gpu, hashing, image, io, labels, network, overlay, parsing, trace_utils).
   - Added module docstrings across remaining service helpers (agent_cascades, classifier_batch/runtime/select, clip_runtime, cluster helpers, context store, detector merge/params, dinov3 runtime, glossary library, overlay tools/views, prepass provenance/recipes, prompt helper/presets, readable, sam3 runs/synonyms, segmentation, tile context).
   - Moved tile context helpers (cluster ownership, tile caption hints, tile payload)
     into services/tile_context.py and updated get_tile_context to use them.
   - Moved prepass window helpers (sam3_text + similarity windows, exemplar filter)
     into services/prepass_windows.py; moved _slice_image_sahi to utils/image.py and
     _resolve_agent_bbox_xyxy to utils/coords.py.
   - Moved similarity expansion helpers into services/prepass_similarity.py and
     provenance helpers into services/prepass_provenance.py.
   - Moved background class helper into utils/classifier_utils.py.
   - Moved labelmap/glossary loader into services/datasets.py with local wrapper.
   - Moved detection payload + YOLO norm helpers into utils/coords.py.
   - Moved SAM3 synonym generation + cache into services/sam3_synonyms.py.
   - Moved cluster handle/index helpers into services/cluster_handles.py.
   - Moved classifier selection helpers into services/classifier_select.py.
   - Moved grid tool usage helpers into services/prepass_grid.py.
   - Moved overlay base/crop helpers into services/overlay_tools.py.
   - Moved classifier batching helpers into services/classifier_batch.py.
   - Moved detector NMS merge helpers into services/detector_merge.py.
   - Moved detector parameter clamping helpers into services/detector_params.py.
   - Moved readable logger helper into services/readable.py.
   - Moved SAM3 availability guard into services/prepass_config.py.
   - Moved calibration helpers (sample/hash/link) into services/calibration_helpers.py.
   - Moved calibration image listing into services/calibration_helpers.py.
   - Moved calibration atomic record writer into services/calibration_helpers.py.
   - Moved calibration update helper into services/calibration_helpers.py.
   - Moved calibration cache-image helper into services/calibration_helpers.py.
   - Moved SAM3 prompt variant helper into services/sam3_synonyms.py.
   - Moved agent context store/chunk wrappers into services/context_store.py.
   - Moved overlay view helpers into services/overlay_views.py.
   - Moved tile context payload builder into services/tile_context.py.
   - Moved similarity exemplar selector into services/prepass.py.
   - Moved deep prepass cleanup into services/prepass.py.
   - Moved deep prepass part A into services/prepass.py.
   - Moved deep prepass wrapper into services/prepass.py.
   - Moved deep prepass caption into services/prepass.py.
   - Moved legacy prepass wrapper into services/prepass.py.
   - Moved calibration prepass worker into services/calibration_helpers.py.
   - Moved Qwen caption helper utilities into services/qwen.py.
   - Moved Qwen text prompt helpers into services/qwen.py.
   - Moved calibration job orchestration into services/calibration.py.
   - Moved detector inference tool into services/detectors.py.
   - Moved detector runtime loaders into services/detectors.py.
   - Moved detector active/default config helpers into services/detectors.py.
   - Moved classifier review/batching helpers into services/classifier.py.
   - Moved classifier path resolve + head load + proba helpers into services/classifier.py.
   - Moved classifier keep-mask helper into services/classifier.py.
   - Moved classifier normalize-embeddings resolver into services/classifier.py.
   - Moved active head normalize resolver into services/classifier.py.
   - Moved CLIP head artifact save/load into services/classifier.py.
   - Moved clip head background guard settings helper into services/classifier.py.
   - Moved clip model inference helper into services/classifier.py.
   - Moved clip auto-predict label/details helpers into services/classifier.py.
   - Moved clip head scoring helper into services/classifier.py.
   - Moved clip head sweep/tuning helpers into services/classifier.py.
   - Moved CLIP dataset validation helpers into services/classifier.py.
   - Moved CLIP labelmap/classifier listing helpers into services/classifier.py.
   - Moved prompt evaluation helpers into services/calibration_metrics.py.
   - Moved prompt expansion helpers into services/qwen.py.
   - Moved seed-threshold + step-selection helpers into services/calibration_metrics.py.
   - Moved agent recipe delete/list helpers into services/prepass_recipes.py.
   - Moved agent recipe persist/load/zip helpers into services/prepass_recipes.py.
   - Moved agent recipe import helpers into services/prepass_recipes.py.
   - Moved agent cascade persistence helpers into services/agent_cascades.py.
   - Moved agent cascade import helpers into services/agent_cascades.py.
   - Moved prepass recipe directory/list/manifest helpers into services/prepass_recipes.py.
   - Moved prepass recipe asset collection helper into services/prepass_recipes.py.
   - Moved prepass recipe import helper into services/prepass_recipes.py.
   - Moved prepass recipe export helper into services/prepass_recipes.py.
   - Moved prepass recipe CRUD helpers into services/prepass_recipes.py.
   - Moved prompt helper preset helpers into services/prompt_helper_presets.py.
   - Moved prompt helper job serializer into services/prompt_helper.py.
   - Moved dataset artifact purge helper into services/datasets.py.
   - Moved Qwen label collection helpers into services/datasets.py.
   - Moved YOLO labelmap discovery helper into services/datasets.py.
   - Removed YOLO/RF‑DETR run/meta wrappers (run_dir, load_meta, write_meta, load_active)
     and updated all call sites to *_impl variants with explicit deps.
     Validation to run later:
     - Tier‑0: list_yolo_runs/list_rfdetr_runs + get/set active
     - Tier‑0: download_yolo_run/download_rfdetr_run + run summaries
     - Tier‑1: YOLO/RF‑DETR training cancel/write meta paths
   - Removed agent mining + prompt helper preset thin wrappers and inlined impl calls
     (agent_mining_get_recipe/cascade, list/get prompt helper presets).
   - Removed _write_coco_annotations wrapper and switched to impl directly.
     Validation to run later:
     - Tier‑0: agent mining recipe/cascade GET/export
     - Tier‑0: prompt helper preset list/get
     - Tier‑0: segmentation build COCO split output
   - Removed prompt‑recipe evaluation wrappers (sanitize prompts, GT index,
     candidate evaluation, prompt detections, recipe build) and inlined *_impl
     calls with explicit deps.
     Validation to run later:
     - Tier‑1: prompt helper recipe generation + metrics
   - Removed duplicate sam3_train_cache_size/sam3_train_cache_purge definitions
     (later duplicate in localinferenceapi.py). No behavior change; router already
     bound to original definitions.
   - Moved yolo_to_corners helper into utils/coords as _yolo_to_xyxy_int and
     removed the localinferenceapi duplicate. Updated call sites to use the
     shared helper to reduce drift.
   - Removed local to_yolo helper; call sites now use utils/coords
     _xyxy_to_yolo_norm_list for consistent YOLO conversion.
   - Moved binary mask encode/decode + mask→polygon helpers into utils/coco
     (_encode_binary_mask_impl/_decode_binary_mask_impl/_mask_to_polygon_impl),
     removing localinferenceapi duplicates. Call sites now pass
     MASK_ENCODE_MAX_BYTES explicitly.
   - Removed unused ConvexHull import from localinferenceapi.py (now owned by
     utils/coco mask helpers).
   - Moved mask_to_bounding_box helper into utils/coords as _mask_to_bounding_box
     and removed localinferenceapi duplicate.
   - Ran py_compile on localinferenceapi.py + utils/coco.py + utils/coords.py
     after these moves (no syntax errors).
   - Added services/prepass _build_deep_prepass_runners_impl to encapsulate
     deep prepass runner wiring; localinferenceapi now assigns the four
     _agent_run_deep_prepass* callables from this builder instead of defining
     wrappers inline. (localinferenceapi shrinks; tests still import the
     callable names.)
   - Removed list_prepass_recipes + list_clip_* wrappers and inlined impl
     calls in routers; removed _resolve_active_head_normalize_embeddings wrapper.
     Validation to run later:
     - Tier‑0: prepass recipe list endpoint
     - Tier‑0: clip classifiers/labelmaps list endpoints
     - Tier‑0: set_active_model path (normalize embeddings)
   - Removed list_sam3_runs wrapper; registry router now uses impl directly.
     Validation to run later:
     - Tier‑0: SAM3 run list/delete/promote
   - Moved common Pydantic schemas (Base64Payload, PredictResponse, BboxModel,
     CropZipRequest, PointPrompt, BboxPrompt, SamPreloadRequest) into
     models/schemas.py and updated localinferenceapi imports.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved SamPreloadResponse, SamSlotStatus, SamActivateRequest/Response,
     PredictorSettings into models/schemas.py and removed local duplicates.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved Sam3VisualPrompt and SamPointAutoResponse into models/schemas.py and
     removed localinferenceapi duplicates.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved Qwen detection + inference + caption schemas (QwenDetection,
     QwenInferenceRequest/Response, QwenCaptionHint/Request/Response) into
     models/schemas.py and removed localinferenceapi duplicates.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved Qwen prepass + calibration schemas (QwenPrepassRequest/Response,
     CalibrationRequest, AgentToolCall/Result/TraceEvent) into models/schemas.py
     and removed localinferenceapi duplicates.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved Qwen prompt/runtime schemas (QwenPromptSection/Config,
     QwenRuntimeSettings/Update) into models/schemas.py and removed local
     duplicates.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved model activation schemas (Sam3ModelActivateRequest,
     QwenModelActivateRequest, ActiveModelRequest/Response) into
     models/schemas.py and removed local duplicates.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved SegmentationBuildRequest into models/schemas.py and removed local
     duplicate.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved training + detector request schemas (QwenTrainRequest,
     Sam3TrainRequest, YoloTrainRequest, YoloHeadGraftRequest/DryRun,
     RfDetrTrainRequest, Yolo/RF‑DETR region/full/windowed request/response,
     Active run request types) into models/schemas.py and removed local
     duplicates.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved Sam3TextPromptResponse/AutoResponse into models/schemas.py and
     removed local duplicates.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Moved PredictorSettingsUpdate, MultiPointPrompt, YoloBboxOutput, and
     Sam3TextPrompt into models/schemas.py; removed local duplicates.
     Validation to run later:
     - Tier‑0/Tier‑1 skip‑GPU
     - py_compile localinferenceapi.py + models/schemas.py (done)
   - Added models/__init__.py for explicit package marker.
   - Removed list/get active wrappers for YOLO + RF‑DETR runs; routers now use
     *_impl directly with explicit deps.
     Validation to run later:
     - Tier‑0: list_yolo_runs/list_rfdetr_runs + get/set active in UI
   - Removed YOLO model-source + training monitor wrappers; training thread now
     invokes _yolo_monitor_training_impl directly with explicit deps.
     Validation to run later:
     - Tier‑1: YOLO training monitor + metrics series capture
   - Removed dataset metadata persistence wrappers; all callers now use
     *_persist_*_metadata_impl directly with explicit meta_name/logger args.
     Validation to run later:
     - Tier‑0: dataset list/registry metadata refresh
     - Tier‑1: segmentation build + SAM3 dataset resplit metadata

   Helpers to move in Stage 2 (do not forget):
   - Completed: _normalize_labelmap_glossary (utils/glossary)
   - Completed: _normalize_window_xyxy (utils/coords)
   - Completed: _normalize_labelmap_entries (utils/labels)
   - Completed: _write_prepass_recipe_meta / _load_prepass_recipe_meta (services/prepass_recipes)
   - Completed: _load_dataset_glossary / _load_qwen_labelmap (services/datasets)
   - Completed: _load_glossary_library / _normalize_glossary_name (services/glossary_library)
   - Completed: _normalize_recipe_thresholds (services/prepass_config)

Stage 3 — Calibration Service Extraction
17. Create services/calibration.py; move job orchestration.
18. Create services/calibration_metrics.py for eval logic.
19. Ensure MLP and XGB paths are both wired + selectable.
20. Update API handlers to call services/calibration.py.
21. Run Tier‑0 + Tier‑1 fuzz:
    - Verify both calibration models run
    - Verify metric schema consistent
    - Verify dedupe/eval IoU settings applied correctly
    - Verify classifier required guard works
    - Verify missing detectors fail fast

Stage 4 — Detector Registry + Inference
22. Create services/detectors.py for model loading + inference.
23. Create services/detector_registry.py for active model selection.
24. Ensure detector selection supports multiple models per run.
25. Update detector endpoints to call services/detectors.py.
26. Run Tier‑0 + Tier‑1 fuzz:
    - Verify full‑frame + SAHI outputs
    - Verify missing weights error handling
    - Verify RF‑DETR labelmap mismatch throws error
    - Verify concurrency guard prevents overlapping inference

Stage 5 — Classifier Registry + Inference
27. Create services/classifier.py for batch inference.
28. Create services/classifier_registry.py for active model selection.
29. Ensure full per‑class probability vectors are returned.
30. Update classifier endpoints to call services/classifier.py.
31. Run Tier‑0 + Tier‑1 fuzz:
    - Verify batch inference works
    - Verify score vectors preserved
    - Verify GPU OOM fallback reduces batch size

Stage 6 — SAM3 + Qwen Helpers
32. Create services/sam3.py (text + similarity + windowed helpers).
33. Create services/qwen.py (captioning + glossary expansion).
34. Ensure SAM3 text + similarity use image‑first cache order.
35. Ensure Qwen prompt expansion is capped by per‑class config.
36. Update endpoints to call services/sam3.py + services/qwen.py.
37. Run Tier‑0 + Tier‑1 fuzz:
    - Verify windowed SAM3 text/similarity
    - Verify glossary expansion prompt consistency
    - Verify captioning runs full + windowed
    - Verify caption prompt avoids labelmap tokens

Stage 7 — Router Split
38. Create api/prepass.py with APIRouter and move prepass routes.
39. Create api/calibration.py and move calibration routes.
40. Create api/detectors.py, api/classifiers.py, api/qwen.py, api/sam3.py.
41. Update localinferenceapi.py to include routers only.
42. Run Tier‑0 + Tier‑1 fuzz:
    - Confirm endpoint paths unchanged
    - Confirm OpenAPI routes intact
    - Confirm UI still loads all tabs (manual smoke check)

Stage 8 — Dead Code Removal
43. Generate a dead‑code report (AST + route inventory).
44. Remove a small batch of unused functions (20–40).
45. Run Tier‑0 + Tier‑1 fuzz tests.
46. Repeat steps 43–45 until no high‑confidence dead code remains.
    - Keep a log of removed functions for audit
    - Candidate list to verify:
      - ClipDatasetUploadJob + CLIP_DATASET_JOBS/LOCK (unreferenced)
      - QwenDatasetUploadJob + QWEN_DATASET_JOBS/LOCK (unreferenced)

Stage 8 progress
----------------
- 2026-02-02: Removed unused ClipDatasetUploadJob/QwenDatasetUploadJob
  dataclasses and CLIP_DATASET_JOBS/QWEN_DATASET_JOBS registries (no references
  anywhere in code). Validation to run later:
  - Tier‑0: dataset upload endpoints unaffected
- 2026-02-02: Re-ran unused-def scans (uses=0) after removal; no additional
  high-confidence dead code found. Stage 8 is paused pending deeper analysis
  or new evidence of unused code.
- 2026-02-02: Removed legacy sentinel _AgentToolRunner (unused). Validation:
  - Tier‑0: agent tools registry unaffected
- 2026-02-02: Verified api/ + services/ + utils/ modules already include
  module docstrings (Stage 10 step 51 satisfied; no edits needed).
- 2026-02-02: Updated readme.md repository layout to document api/ + services/
  + utils/ and clarify localinferenceapi.py as a thin router shim.
- 2026-02-02: Added backend module map in readme.md to document where core
  logic lives (prepass/calibration, detectors, classifier, SAM3, Qwen).
- 2026-02-02: Added high‑level backend flow diagram + migration note in
  readme.md (localinferenceapi.py is router shim; logic in services/utils).
- 2026-02-02: Updated secondary “Codebase map” section in readme.md to reflect
  api/ + services/ + utils/ layout.
- 2026-02-02: Updated tools/run_refactor_validation.sh to include api/*.py in
  py_compile for early syntax checking after router split.
- 2026-02-02: Logged existing TODO in localinferenceapi.py (polygon mask
  enrichment) as a deferred post‑refactor enhancement (no change).
- 2026-02-02: Added SKIP_FUZZ option to tools/run_refactor_validation.sh so
  py_compile can run even when HTTP access to 127.0.0.1 is blocked.
- 2026-02-02: Updated tools/fuzz_tier0.py to align with current endpoint
  schemas (health_summary ok/status, detectors default mode/active, clip
  classifiers list payload) and increased timeouts for heavy endpoints.

Stage 9 — Final Verification
47. Run Tier‑2 fuzz (full pipeline on 2–4 images).
48. Run end‑to‑end benchmark on 10‑image subset.
49. Compare regression summary to baseline (<=2% variance).
50. Update Readme with new architecture diagram and migration notes.
    - Include “what moved where” mapping table

Stage 10 — Cleanup + Docs
51. Add module docstrings to services/ + api/ files.
52. Update developer docs to reference new module locations.
53. Remove any vestigial import shims or compatibility hacks.
54. Final Tier‑0 + Tier‑1 fuzz run.
    - Confirm all scripts reference new module paths

Progress Log
------------
- Stage 3: moved seed‑stage prompt subset + step config helpers into
  services/calibration_metrics.py and converted local wrappers.
- Stage 3: moved step recipe builder + clip prefilter crop sampler into
  services/calibration_metrics.py and converted local wrappers.
- Stage 3: moved step normalization helper into services/calibration_metrics.py
  and converted local wrapper.
- Stage 3: moved CLIP prompt prefilter helper into services/calibration_metrics.py
  and converted local wrapper.
- Stage 1: moved YOLO layout detection helpers into services/datasets.py and
  converted local wrappers.
- Stage 1: moved dataset resolution helpers into services/datasets.py and
  converted local wrappers.
- Stage 1: moved dataset integrity helpers into services/datasets.py and
  converted local wrappers.
- Stage 1: moved glossary library upsert/delete helpers into
  services/glossary_library.py and converted local wrappers.
- Stage 1: moved YOLO/RF‑DETR training dataset resolution into
  services/datasets.py and converted local wrappers.
- Stage 1: moved agent recipe parsing/validation helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 1: moved YOLO run-id + directory signature helpers into utils/io.py
  and converted local wrappers.
- Stage 1: moved labelmap/dataset signature helpers into services/datasets.py
  and converted local wrappers.
- Stage 4: moved YOLO/RF‑DETR run metadata + metrics helpers into
  services/detectors.py and converted local wrappers.
- Stage 4: moved YOLO/RF‑DETR run listing helpers into services/detectors.py
  and converted local wrappers.
- Stage 4: moved YOLO/RF‑DETR extract helpers into services/detectors.py and
  converted local wrappers.
- Stage 4: moved detector image resolver into services/detectors.py and
  converted local wrapper.
- Stage 4: moved YOLO device arg + p2 scale helpers into services/detectors.py
  and converted local wrappers.
- Stage 4: moved RF‑DETR variant/checkpoint/log helpers into services/detectors.py
  and converted local wrappers.
- Stage 4: moved RF‑DETR metric sanitize + aug policy helpers into
  services/detectors.py and converted local wrappers.
- Stage 4: moved RF‑DETR augmentation install/restore helpers into
  services/detectors.py and converted local wrappers.
- Stage 4: moved RF‑DETR checkpoint epoch helper into services/detectors.py
  and converted local wrapper.
- Stage 4: moved RF‑DETR monitor training loop into services/detectors.py and
  converted local wrapper.
- Stage 4: moved YOLO augment + CSV parse + training monitor helpers into
  services/detectors.py and converted local wrappers.
- Stage 4: moved checkpoint optimizer stripping helper into
  services/detectors.py and converted local wrapper.
- Stage 4: moved YOLO/RF‑DETR labelmap loaders into services/detectors.py and
  converted local wrappers.
- Stage 4: moved RF‑DETR dataset prep + remap helpers into services/detectors.py
  and converted local wrappers.
- Stage 4: moved YOLO data.yaml writer into services/detectors.py and converted
  local wrapper.
- Stage 4: moved YOLO model source + variant YAML helpers + detect module helpers
  into services/detectors.py and converted local wrappers.
- Stage 4: moved RF‑DETR DDP worker into services/detectors.py and converted
  local wrapper.
- Stage 1: moved free-port helper into utils/network.py and converted wrapper.
- Stage 1: moved stable hash helper into utils/hashing.py and converted wrapper.
- Stage 1: moved base64 image decode helper into utils/image.py and converted
  wrapper.
- Stage 1: moved COCO info/write/ensure helpers into utils/coco.py and converted
  local wrappers.
- Stage 1: moved path_is_within_root helper into utils/io.py and converted
  local wrapper.
- Stage 2: restored classifier resolve/load wrappers after classifier service move.
- Stage 1: moved validate_cuda_device_ids helper into utils/gpu.py and converted
  local wrapper.
- Stage 1: moved COCO validity/segmentation helpers into utils/coco.py and
  converted local wrappers.
- Stage 1: moved YOLO label image lookup helper into utils/image.py and
  converted local wrapper.
- Stage 1: moved COCO image path + label relpath helpers into utils/image.py and
  converted local wrappers.
- Stage 1: moved Qwen JSONL label extraction helpers into services/datasets.py
  and converted local wrappers.
- Stage 1: moved YOLO labelmap discovery helper into services/datasets.py and
  converted local wrapper.
- Stage 1: moved YOLO→COCO conversion into services/datasets.py and converted
  local wrapper.
- Stage 1: moved Qwen→COCO conversion into services/datasets.py and converted
  local wrapper.
- Stage 1: moved COCO→YOLO conversion into services/datasets.py and converted
  local wrapper.
- Stage 1: moved SAM3 dataset meta resolver into services/datasets.py and
  converted local wrapper.
- Stage 1: moved COCO index loader into services/datasets.py and converted
  local wrapper.
- Stage 8: removed unused prepass recipe wrapper helpers (meta/assets/sha256).
- Stage 8: removed unused COCO path wrapper helpers.
- Stage 8: removed unused labelmap dataset wrapper helpers (Qwen labels +
  YOLO labelmap discovery + payload extraction).
- Stage 8: removed unused agent mining cache/meta dir helpers.
- Stage 8: removed unused agent prepass helper wrappers (run_prepass,
  finalize_detections, set_active_detections).
- Stage 8: removed unused misc wrappers (agent classifier review, COCO info
  helpers, CLIP mining loader wrapper, prompt self-filter, calibration helpers,
  Qwen prompt config setter, dataset signature wrapper, label-id validator,
  pruning helpers).
- Stage 8: removed unused Qwen dataset metadata persist wrapper.
- Stage 8: removed unused service impls (legacy agent prepass, clip mining loader,
  calibration midpoints/replay, qwen prompt self-filter, dataset signature helpers).
- Stage 8: re‑wired GPU device ID validation in RF‑DETR training (uses utils/gpu).
- Stage 8: removed unused prepass recipe import hooks in localinferenceapi.py.
- Stage 8: removed unused glossary library imports in localinferenceapi.py.
- Stage 8: pruned unused imports in localinferenceapi.py (prepass/grid/coords/overlay/llm/readable/classifier/calibration_metrics/qwen).
- Stage 8: removed unused helpers in services/prepass + services/prepass_grid + services/datasets + services/prepass_recipes + services/qwen + services/readable.
- Stage 8: removed unused helpers in utils (coords remap, image size, io atomic/json writers, parsing device IDs, overlay data URI, trace sanitize messages) and deleted utils/text.py + utils/llm.py.
- Stage 8: removed unused helpers in services/classifier + services/calibration_metrics + services/readable (post-clean).
- Stage 8: pruned unused imports across services/utils (detectors/datasets/prepass/etc.); ignored vendor libs.
- Stage 8: pruned unused imports in tools scripts (detect_missclassifications, qwen_training, train_ensemble_mlp/xgb).
- Stage 9: added tools/run_refactor_validation.sh (py_compile + Tier‑0/Tier‑1 wrapper).
- Stage 10: added module docstrings to core services (prepass, calibration, detectors, qwen, classifier, calibration_metrics, datasets, prepass_windows/similarity/grid, qwen_runtime, sam3_runtime, *_jobs, runtime_unload, calibration_helpers, prepass_config).
- Stage 2: moved head‑graft audit + force‑stop helpers into
  services/detector_jobs.py and converted local wrappers.
- Stage 3: moved hard‑negative export helper into services/calibration_metrics.py
  and converted local wrapper.
- Stage 2: moved agent recipe delete/list helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved agent recipe persist/load/zip helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved agent recipe import helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved agent cascade helpers into
  services/agent_cascades.py and converted local wrappers.
- Stage 1: moved labelmap mismatch helpers into utils/labels.py and updated
  local wrappers.
- Stage 1: moved SAM3 run listing helpers into services/sam3_runs.py and
  updated local wrappers.
- Stage 1: moved detector infer state setters into services/detectors.py and
  updated local wrappers.
- Stage 1: moved SAM3 cache clearing helper into services/sam3_runtime.py and
  updated local wrapper.
- Stage 1: moved SAM3 device resolution helpers into services/sam3_runtime.py
  and updated local wrappers.
- Stage 1: moved SAM3 runtime reset helper into services/sam3_runtime.py and
  updated local wrapper.
- Stage 1: moved SAM3 backend selector into services/sam3_runtime.py and
  updated local wrapper.
- Stage 1: moved SAM3 text runtime loader into services/sam3_runtime.py and
  updated local wrapper.
- Stage 1: moved Qwen runtime reset/unload helpers into services/qwen_runtime.py
  and updated local wrappers.
- Stage 1: moved Qwen caption cache eviction helper into services/qwen_runtime.py
  and updated local wrapper.
- Stage 1: moved Qwen variant resolver into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen model suffix handler into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen load error formatter into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen device resolver into services/qwen_runtime.py and updated local wrapper.
- Stage 1: moved Qwen prompt config get/set into services/qwen.py and updated local wrappers.
- Stage 1: moved Qwen prompt renderer into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen JSON block parsing into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen coordinate scaling helpers into utils/coords.py and updated local usage.
- Stage 1: moved inference runtime unload helpers into services/runtime_unload.py
  and updated local wrappers.
- Stage 1: moved training runtime prepare/finalize helpers into
  services/runtime_unload.py and updated local wrappers.
- Stage 1: moved DINOv3 device resolver into services/dinov3_runtime.py and
  updated local wrapper.
- Stage 1: moved CLIP backbone suspend/resume helpers into services/clip_runtime.py
  and updated local wrappers.
- Stage 1: moved CLIP mining backbone loader into services/clip_runtime.py and
  updated local wrapper.
- Stage 1: moved classifier backbone resume helper into services/classifier_runtime.py
  and updated local wrapper.
- Stage 2: moved agent cascade import helpers into
  services/agent_cascades.py and converted local wrappers.
- Stage 2: moved prepass recipe directory/list/manifest helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved prepass recipe asset collection helper into
  services/prepass_recipes.py and converted local wrapper.
- Stage 2: moved prepass recipe import helper into
  services/prepass_recipes.py and converted local wrapper.
- Stage 2: moved prepass recipe export helper into
  services/prepass_recipes.py and converted local wrapper.
- Stage 2: moved prepass recipe CRUD helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved prompt helper preset helpers into
  services/prompt_helper_presets.py and converted local wrappers.
- Stage 2: moved prompt helper job serializer into
  services/prompt_helper.py and converted local wrapper.
- Stage 2: moved dataset artifact purge helper into
  services/datasets.py and converted local wrapper.
- Stage 2: moved Qwen label collection helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved YOLO labelmap discovery helper into
  services/datasets.py and converted local wrapper.
- Stage 2: moved Qwen dataset signature helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved dataset metadata helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved Qwen dataset metadata helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved SAM3 dataset metadata helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved dataset image/caption counters into
  services/datasets.py and converted local wrappers.
- Stage 2: moved dataset list builder into
  services/datasets.py and converted local wrapper.
- Stage 2.5: moved caption label helpers (allowed labels + degenerate check) into
  services/qwen.py and converted local wrappers.
- Stage 2.5: moved window positioning helper into
  services/qwen.py and converted local wrapper.
- Stage 1: moved dir_size_bytes into utils/io and converted local wrapper.
- Stage 2: moved segmentation job serializer into
  services/segmentation.py and converted local wrapper.
- Stage 2: moved segmentation job log/update helpers into
  services/segmentation.py and converted local wrapper.
- Stage 2: moved Qwen training job serializer into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved Qwen training GET logger into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved Qwen training job log/update helpers into
  services/qwen_jobs.py and converted local wrappers.
- Stage 2: moved Qwen training metric append helper into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved Qwen metric coercion helper into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved Qwen metric summary helper into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved CLIP training job serializer into
  services/classifier_jobs.py and converted local wrapper.
- Stage 2: moved CLIP training job log/update helpers into
  services/classifier_jobs.py and converted local wrappers.
- Stage 2: moved CLIP training job metric append into
  services/classifier_jobs.py and converted local wrapper.
- Stage 2: moved SAM3 training job serializer into
  services/sam3_jobs.py and converted local wrapper.
- Stage 2: moved SAM3 training job log/update helpers into
  services/sam3_jobs.py and converted local wrappers.
- Stage 2: moved YOLO/RF‑DETR/head‑graft job serializers into
  services/detector_jobs.py and converted local wrappers.
- Stage 2: moved YOLO/RF‑DETR job log/update helpers into
  services/detector_jobs.py and converted local wrappers.
- Stage 2: moved head‑graft job log/update helpers into
  services/detector_jobs.py and converted local wrappers.
- Stage 2.5: moved Qwen caption runtime loader into
  services/qwen_runtime.py and converted local wrapper.
- 2026-02-02: Stage 7 pilot — moved /detectors/default endpoints into
  api/detectors_default.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /detectors/default GET/POST returns same payload.
  - Confirm OpenAPI still lists /detectors/default (no duplicate paths).
- 2026-02-02: Stage 7 pilot — moved /predictor_settings endpoints into
  api/predictor_settings.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /predictor_settings GET/POST returns same payload.
- 2026-02-02: Stage 7 pilot — moved /runtime/unload endpoint into
  api/runtime.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /runtime/unload still unloads all inference runtimes.
- 2026-02-02: Stage 7 pilot — moved /system/* endpoints into
  api/system.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /system/gpu, /system/storage_check, /system/health_summary responses unchanged.
- 2026-02-02: Stage 7 pilot — moved /qwen/status + /qwen/settings + /qwen/unload
  into api/qwen_status.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /qwen/status response unchanged.
  - Tier‑1: /qwen/settings GET/POST response unchanged.
  - Tier‑1: /qwen/unload still clears runtime.
- 2026-02-02: Stage 7 pilot — moved /sam_slots + /sam_activate_slot endpoints
  into api/sam_slots.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /sam_slots returns same slot status list.
  - Tier‑1: /sam_activate_slot promotes slot as before.
- 2026-02-02: Stage 7 pilot — moved /qwen/train/* endpoints into
  api/qwen_training.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /qwen/train/jobs create + list + get + cancel unchanged.
  - Tier‑1: /qwen/train/cache_size and /qwen/train/cache/purge unchanged.
- 2026-02-02: Stage 7 pilot — moved /qwen/models endpoints into
  api/qwen_models.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /qwen/models list unchanged.
  - Tier‑1: /qwen/models/activate unchanged.
- 2026-02-02: Stage 7 pilot — moved /clip/active_model endpoints into
  api/clip_active_model.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /clip/active_model GET/POST response unchanged.
- 2026-02-02: Stage 7 pilot — moved /sam_preload endpoint into
  api/sam_preload.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /sam_preload behavior unchanged.
- 2026-02-02: Stage 7 pilot — moved /qwen/infer endpoint into
  api/qwen_infer.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /qwen/infer response unchanged.
- 2026-02-02: Stage 7 pilot — moved /qwen/caption endpoint into
  api/qwen_caption.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /qwen/caption response unchanged.
- 2026-02-02: Stage 7 pilot — moved /calibration/jobs endpoints into
  api/calibration.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /calibration/jobs create/list/get/cancel unchanged.
- 2026-02-02: Stage 7 pilot — moved /prepass/recipes endpoints into
  api/prepass.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /prepass/recipes list/get/save/delete unchanged.
  - Tier‑1: /prepass/recipes export + import/import-raw unchanged.
- 2026-02-02: Stage 7 pilot — moved /qwen/prepass endpoint into
  api/qwen_prepass.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /qwen/prepass response unchanged.
- 2026-02-02: Stage 7 pilot — moved /clip/* registry endpoints into
  api/clip_registry.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /clip/backbones unchanged.
  - Tier‑1: /clip/classifiers list/download/delete/rename unchanged.
  - Tier‑1: /clip/labelmaps list/download/delete unchanged.
- 2026-02-02: Stage 7 pilot — moved /clip/train endpoints into
  api/clip_training.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /clip/train create + list + get + cancel unchanged.
- 2026-02-02: Stage 7 pilot — moved /fs/upload_* endpoints into
  api/fs_upload.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /fs/upload_classifier and /fs/upload_labelmap unchanged.
- 2026-02-02: Stage 7 pilot — moved /predict_base64 endpoint into
  api/predict_base64.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /predict_base64 response unchanged.
- 2026-02-02: Stage 7 pilot — moved /crop_zip_* endpoints into
  api/crop_zip.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /crop_zip_init, /crop_zip_chunk, /crop_zip_finalize unchanged.
- 2026-02-02: Stage 7 pilot — moved /sam3/prompt_helper/* endpoints into
  api/sam3_prompt_helper.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /sam3/prompt_helper/suggest|expand unchanged.
  - Tier‑1: /sam3/prompt_helper/jobs + /search + /recipe unchanged.
  - Tier‑1: /sam3/prompt_helper/presets list/get/create unchanged.
  - Tier‑1: /sam3/prompt_helper/jobs list/get unchanged.
- 2026-02-02: Stage 7 pilot — moved /sam3/train/* endpoints into
  api/sam3_training.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /sam3/train/jobs create/list/get/cancel unchanged.
  - Tier‑1: /sam3/train/cache_size and /sam3/train/cache/purge unchanged.
- 2026-02-02: Stage 7 pilot — moved /sam3/storage/* and /sam3/models/* endpoints into
  api/sam3_registry.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /sam3/storage/runs list/delete/promote unchanged.
  - Tier‑1: /sam3/models/available + /sam3/models/activate unchanged.
- 2026-02-02: Stage 8 pilot — moved /sam3/text_prompt, /sam3/text_prompt_auto,
  /sam3/visual_prompt, /sam_point, /sam_bbox_auto, /sam_point_auto,
  /sam_point_multi, /sam_point_multi_auto, /sam_bbox endpoints into
  api/sam3_prompts.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: SAM3 text prompt responses unchanged.
  - Tier‑1: SAM3 visual prompt responses unchanged.
  - Tier‑1: SAM3 point/bbox auto responses unchanged.
  - Tier‑1: SAM3 point multi responses unchanged.
- 2026-02-02: Stage 8 pilot — moved /agent_mining/* endpoints into
  api/agent_mining.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /agent_mining/jobs create/list/get/cancel unchanged.
  - Tier‑1: /agent_mining/results/latest unchanged.
  - Tier‑1: /agent_mining/cache_size + /cache/purge unchanged.
  - Tier‑1: /agent_mining/apply_image + /apply_image_chain unchanged.
  - Tier‑1: /agent_mining/recipes CRUD + import/export unchanged.
  - Tier‑1: /agent_mining/cascades CRUD + import/export unchanged.
- 2026-02-02: Stage 8 pilot — moved /segmentation/build/jobs endpoints into
  api/segmentation_build.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /segmentation/build/jobs create/list/get unchanged.
- 2026-02-02: Stage 8 pilot — moved /yolo/train/* and /yolo/head_graft/*
  endpoints into api/yolo_training.py and mounted via include_router in
  localinferenceapi.
  Validation to run later:
  - Tier‑1: /yolo/train/jobs create/list/get/cancel unchanged.
  - Tier‑1: /yolo/head_graft jobs/dry_run/list/get/cancel unchanged.
- 2026-02-02: Stage 8 pilot — moved /rfdetr/train/* endpoints into
  api/rfdetr_training.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /rfdetr/train/jobs create/list/get/cancel unchanged.
- 2026-02-02: Stage 8 pilot — moved RF‑DETR registry + inference endpoints into
  api/rfdetr.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /rfdetr/variants + /rfdetr/runs unchanged.
  - Tier‑1: /rfdetr/active get/set unchanged.
  - Tier‑1: /rfdetr/predict_region/full/windowed unchanged.
  - Tier‑1: /rfdetr/runs/{run_id} summary/download/delete unchanged.
- 2026-02-02: Stage 8 pilot — moved YOLO registry + inference endpoints into
  api/yolo.py and mounted via include_router in localinferenceapi.
  Validation to run later:
  - Tier‑1: /yolo/variants + /yolo/runs unchanged.
  - Tier‑1: /yolo/active get/set unchanged.
  - Tier‑1: /yolo/predict_region/full/windowed unchanged.
  - Tier‑1: /yolo/runs/{run_id} summary/download/delete unchanged.
  - Tier‑1: /yolo/head_graft/jobs/{job_id}/bundle unchanged.
- 2026-02-02: Stage 9 — removed dataset conversion wrappers
  (_convert_yolo/qwen/coco_dataset_to_*), _resolve_sam3_dataset_meta wrapper,
  and _load_coco_index wrapper. Call sites now use *_impl directly.
  Validation to run later:
  - Tier‑1: dataset conversion endpoints (YOLO/Qwen/COCO) unchanged.
  - Tier‑1: SAM3 dataset meta resolution for conversion flows unchanged.
  - Tier‑1: agent mining prompt helper + dataset search endpoints unchanged.
- 2026-02-02: Stage 9 — removed RF‑DETR training helper wrappers
  (_rfdetr_parse_log_series/_sanitize_metric/_normalize_aug_policy/
  _install_augmentations/_restore_augmentations/_latest_checkpoint_epoch/
  _monitor_training). Call sites now use *_impl directly and thread monitor
  passes required callbacks explicitly.
  Validation to run later:
  - Tier‑1: RF‑DETR training job monitoring metrics unchanged.
  - Tier‑1: RF‑DETR augmentation policy handling unchanged.
- 2026-02-02: Stage 9 — removed YOLO helper wrappers
  (_yolo_load_labelmap/_yolo_device_arg/_yolo_build_aug_args/
  _yolo_parse_results_csv). Call sites now use *_impl directly.
  Validation to run later:
  - Tier‑1: YOLO training metrics parsing unchanged.
  - Tier‑1: YOLO head‑graft labelmap handling unchanged.
- 2026-02-02: Stage 9 — removed YOLO YAML/head wrapper helpers
  (_yolo_write_data_yaml/_yolo_variant_base_yaml/_yolo_write_variant_yaml/
  _yolo_write_head_graft_yaml/_yolo_find_detect_modules/_yolo_detect_layer_index).
  Call sites now pass impl dependencies explicitly.
  Validation to run later:
  - Tier‑1: YOLO training data YAML creation unchanged.
  - Tier‑1: YOLO head‑graft YAML creation unchanged.
  - Tier‑1: YOLO Detect layer indexing unchanged.
- 2026-02-02: Stage 9 — removed _run_calibration_job wrapper; calibration job
  creation now passes a direct _run_calibration_job_impl lambda with explicit
  dependencies.
  Validation to run later:
  - Tier‑1: /calibration/jobs create/list/get/cancel unchanged.
- 2026-02-02: Stage 9 — removed RF‑DETR dataset helper wrappers
  (_rfdetr_remap_coco_ids/_rfdetr_prepare_dataset). Call sites now use *_impl
  directly with explicit remap_ids_fn wiring.
  Validation to run later:
  - Tier‑1: RF‑DETR dataset prep (COCO remap) unchanged.
- 2026-02-02: Stage 9 — removed agent recipe/cascade loader wrappers
  (_load_agent_recipe/_load_agent_recipe_json_only/_load_agent_cascade).
  Call sites now use *_impl with explicit roots/guards.
  Validation to run later:
  - Tier‑1: agent_mining recipes load/get/export unchanged.
  - Tier‑1: agent_mining cascades load/get/export unchanged.
- 2026-02-02: Stage 9 — removed _yolo_p2_scale wrapper; call sites now use
  _yolo_p2_scale_impl directly.
  Validation to run later:
  - Tier‑1: YOLO model source resolution unchanged.
- 2026-02-02: Stage 9 — removed Qwen caption/text wrapper helpers
  (_build_qwen_caption_prompt/_run_qwen_caption_cleanup/_run_qwen_caption_merge/
  _generate_qwen_text/_parse_prompt_candidates/_generate_prompt_text).
  Call sites now use *_impl directly or local helpers with explicit deps.
  Validation to run later:
  - Tier‑1: Qwen captioning (full + windowed + cleanup/merge) unchanged.
  - Tier‑1: SAM3 synonym expansion text helper unchanged.
- 2026-02-02: Stage 9 — removed agent context helper wrappers
  (_agent_context_store/_agent_context_chunk). Call sites now use *_impl with
  explicit stores/max_bytes.
  Validation to run later:
  - Tier‑1: /prepass/context endpoints unchanged.
- 2026-02-02: Stage 9 — removed classifier batching wrappers
  (_resolve_classifier_batch_size/_predict_proba_batched). Call sites now use
  *_impl directly with explicit dependencies.
  Validation to run later:
  - Tier‑1: classifier review batching unchanged.
- 2026-02-02: Stage 9 — removed SAM3 run helper wrappers
  (_active_run_paths_for_variant/_list_sam3_runs). Call sites now use *_impl
  directly with explicit dependencies.
  Validation to run later:
  - Tier‑1: /sam3/storage runs list unchanged.
- 2026-02-02: Stage 9 — removed clip classifier wrappers
  (_resolve_agent_clip_classifier_path/_load_clip_head_from_classifier).
  Call sites now use *_impl with explicit roots/guards/deps.
  Validation to run later:
  - Tier‑1: classifier download/rename/delete endpoints unchanged.
  - Tier‑1: agent prepass classifier head loading unchanged.
- Stage 9 backlog (next targets):
  - Clip classifier path/head loader wrappers.
  - YOLO/RF‑DETR run dir + load meta wrappers.
  - list_all_datasets + active run path wrappers (if not already inlined).
  - agent tool runner + deep prepass wrappers (only after test harness ready).
  - serializer passthroughs (prompt helper, seg, clip, sam3, yolo, rfdetr, qwen).
- 2026-02-02: Stage 9 — removed training runtime wrapper calls
  (_prepare_for_training/_finalize_training_environment/_unload_non_qwen_runtimes)
  and replaced call sites with *_impl lambdas that pass explicit unload/resume
  dependencies. Updated runtime router unload_all to call impl directly.
  Validation to run later:
  - Tier‑1: /runtime/unload frees SAM/Qwen/detectors as before.
  - Tier‑1: clip/sam3/yolo/rfdetr training start/finish still unloads runtimes.
- 2026-02-02: Stage 9 — removed agent prepass wrapper defs
  (_require_sam3_for_prepass/_sam3_clear_device_pinned_caches/_evict_qwen_caption_entry
  and deep prepass helper wrappers). Replaced with partials/impl lambdas and
  direct impl calls.
  Validation to run later:
  - Tier‑1: prepass (deep) still runs with same trace outputs.
  - Tier‑1: qwen caption cache eviction unchanged.
- 2026-02-02: Stage 9 — replaced job log/update helpers with partials
  for clip/qwen/sam3/yolo/rfdetr/seg + head‑graft audit/log/update.
  Validation to run later:
  - Tier‑1: training job logs/metrics still capped and serialized.
- 2026-02-02: Stage 9 — removed dataset/list/training resolver wrappers
  (_list_all_datasets/_yolo_labels_have_polygons/_resolve_yolo_training_dataset/
   _resolve_rfdetr_training_dataset) and replaced with partials to *_impl.
  Validation to run later:
  - Tier‑1: dataset manager list unchanged.
  - Tier‑1: YOLO + RF‑DETR training dataset resolution unchanged.
- 2026-02-02: Stage 9 — removed agent recipe/cascade persistence wrappers and
  calibration job helper wrappers, replaced with partials or direct impl aliases.
  Validation to run later:
  - Tier‑1: agent_mining recipe/cascade CRUD unchanged.
  - Tier‑1: calibration prepass workers unchanged.
- 2026-02-02: Stage 9 — removed detection extraction wrappers
  (_yolo_extract_detections/_rfdetr_extract_detections) and now alias impl.
  Validation to run later:
  - Tier‑1: YOLO/RF‑DETR inference responses unchanged.
- 2026-02-02: Stage 9 — removed agent recipe/cascade zip helper wrappers
  (_ensure_recipe_zip/_ensure_cascade_zip) and replaced with partials.
  Validation to run later:
  - Tier‑1: agent_mining recipe/cascade export bundles unchanged.
- 2026-02-02: Stage 9 — kept (or restored) run_detector + deep_prepass
  wrappers because they depend on live global state (active labelmap,
  classifier head, SAM3 thresholds). Converting to partials would freeze
  these values. Wrapper bodies still call *_impl with explicit deps.
  Validation to run later:
  - Tier‑1: prepass threshold overrides respected.
  - Tier‑1: active classifier head switching respected.
- 2026-02-02: Stage 9 — AST scan shows only remaining wrapper-like defs are
  deep prepass helpers; keeping them due to dynamic global state usage.
- 2026-02-02: Stage 9 backlog cleared — clip classifier wrappers, YOLO/RF‑DETR
  run/meta wrappers, dataset list wrappers, serializer passthroughs, and
  training runtime wrappers are now removed or replaced with partials. Remaining
  intentional wrappers: deep prepass + run_detector (dynamic state).
- 2026-02-02: scan_unused_defs (max-uses=0, include-underscore) flags many
  API endpoint functions and utility classes with uses=0. This is expected
  because decorated endpoints are only referenced by FastAPI routing. No
  deletions taken; keep for manual review in later cleanup stage.
- 2026-02-02: Stage 2 — moved DetectorDefaultRequest into models/schemas.py
  and removed the local BaseModel class + unused pydantic BaseModel import
  from localinferenceapi.py.
  Validation to run later:
  - Tier‑0/Tier‑1: detector default settings endpoints still accept {mode}.
- 2026-02-02: Stage 2 — removed unused pydantic root_validator/Field imports
  from localinferenceapi.py after schema extraction.
  Validation to run later:
  - Tier‑0: localinferenceapi imports cleanly under py_compile.
- 2026-02-02: Stage 2 — re-ran scan_unused_defs (max-uses=0/1). Only
  router-exposed endpoints + expected globals flagged (uses=1). No further
  high-confidence deletions identified in this pass.
- 2026-02-02: Stage 8 — ran a coarse module-usage scan (string match of
  services.<mod> / utils.<mod> across repo). No unreferenced service or
  util modules found; no deletions taken.
- 2026-02-02: Stage 9 — updated tools/run_refactor_validation.sh to include
  models/*.py in py_compile pass.
  Validation to run later:
  - Tier‑0: py_compile should now cover models package as well.
- 2026-02-02: Stage 9 — manual py_compile run on models/*.py succeeded.
- 2026-02-02: Stage 9 — ran run_refactor_validation.sh with SKIP_FUZZ=1
  (py_compile only). No errors.
- 2026-02-02: Stage 9 — re-ran Tier‑0/Tier‑1 (SKIP_GPU=1) via
  tools/run_refactor_validation.sh. Tier‑0 passed. Tier‑1 skip‑GPU
  succeeded with GPU-dependent steps skipped. Logs in /tmp/tator_fuzz.
- 2026-02-02: Stage 9 — Tier‑0/Tier‑1 full GPU run (SKIP_GPU=0) completed.
  Tier‑1 prepass steps returned labelmap‑mismatch warnings for YOLO/RF‑DETR
  (expected in fuzz_pack). Calibration job started (cal_0c0204ce) and
  returned async job metadata. Logs in /tmp/tator_fuzz.
- 2026-02-02: Stage 9 — fixed tools/fuzz_tier1.py classifier lookup to accept
  list or {classifiers:[...]} payloads.
- 2026-02-02: Stage 10 — Tier‑2 prepass smoke (4 images) completed via
  tools/run_qwen_prepass_smoke.sh; output /tmp/qwen_prepass_smoke_4.jsonl.
- 2026-02-02: Stage 10 — 10‑image prepass benchmark completed via
  tools/run_qwen_prepass_benchmark.sh (prepass‑only). Output:
  /tmp/qwen_prepass_benchmark_10.jsonl; summary in
  /tmp/qwen_prepass_benchmark_10.summary.json. YOLO baseline returned 500s
  during this run (needs follow‑up when API idle).
- 2026-02-02: Stage 10 — Qwen caption sanity check attempted; /qwen/caption
  returned HTTP 503 after retries. Logged to /tmp/qwen_caption_sanity.json;
  needs re‑run when Qwen is available.
- 2026-02-02: Stage 10 — staged new refactor modules (api/, models/,
  services/qwen_generation.py) so they don’t remain untracked.
- 2026-02-02: Stage 8 — second pass confirms no additional high-confidence
  deletions (usage scans + module reference scan). Stage 8 remains paused
  pending new evidence.
- 2026-02-02: Repo hygiene — api/ + models/ + services/qwen_generation.py are
  new refactor modules and must be staged in the next commit (currently untracked).
- 2026-02-03: Tier‑0 fuzz updated to drop deprecated /datasets endpoints and use
  /system/storage_check + /system/gpu instead. Tier‑1 calibration step now
  skips gracefully if job fails, and uses dataset_id=qwen_dataset by default.
- 2026-02-03: Fixed qwen caption merge call‑signature mismatch (pil_img /
  base_model_id / max_new_tokens) and restored qwen model registry stubs to
  prevent /qwen/models 500s. (Model registry remains empty unless custom
  Qwen finetunes are added.)
- 2026-02-03: Restored missing detector helpers: _clamp_conf_value aliases and
  added _xywh_to_xyxy in utils/coords. Tier‑0/Tier‑1 (GPU) now runs end‑to‑end,
  with expected labelmap‑mismatch warnings when fuzz_pack labelmap doesn’t
  match detector labelmaps.
- 2026-02-03: Suppressed TypeError noise from SAM3 similarity expansion in
  services/prepass_similarity.py (skip warnings for TypeError). After uvicorn
  restart, Tier‑1 GPU fuzz prepass warnings cleared. Tier‑0/Tier‑1 GPU run
  completed cleanly (prepass, windowed prepass, captions, calibration job
  metadata returned). Logs in /tmp/tator_fuzz.
- 2026-02-03: UI endpoint smoke tests added:
  - tools/check_ui_endpoints.py (UI ↔ OpenAPI diff)
  - tools/run_ui_smoke.py (GET/POST smoke for label‑tab core endpoints).
  UI smoke now passes: predict_base64, yolo/rfdetr full+windowed, sam_bbox,
  sam_point, qwen/sam3 models, system endpoints.
  Remaining mismatches (missing in OpenAPI but referenced in UI):
    /datasets*, /glossaries*, /qwen/datasets*, /sam3/datasets*.
  These require restoration or UI updates in the next step.
