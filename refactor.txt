Refactor Plan (Incremental + Fuzz-Verified)
==========================================

Goal
----
Clean up unused code and refactor the monolithic backend into maintainable
modules without breaking behavior. This will be done incrementally and
validated by a fuzzing/smoke test after *every* change batch.


Part A — Cleanup Strategy (Dead Code)
-------------------------------------
We will not delete code based on “looks unused” alone. Instead we will use a
triple-check approach and *validate every deletion* with tests.

Signals for deletion:
1) Static usage:
   - No route decorator
   - Not called inside module (AST call graph)
   - Not referenced by docs/scripts
2) Runtime behavior:
   - Fuzz test coverage confirms removal does not break key endpoints
3) Optional manual check:
   - Code is not dynamically invoked (e.g. string name lookup)

Deletion happens in small batches (20–40 functions) so we can isolate errors.


Part B — Refactor Target Structure
----------------------------------

tator/
  api/
    prepass.py
    calibration.py
    datasets.py
    detectors.py
    classifiers.py
    qwen.py
    sam3.py
    jobs.py
    headgraft.py
  services/
    prepass.py
    calibration.py
    detectors.py
    sam3.py
    qwen.py
    classifier.py
    dataset_manager.py
    recipes.py
    model_registry.py
  models/
    schemas.py
    jobs.py
    recipes.py
  storage/
    datasets.py
    cache.py
    jobs.py
  utils/
    io.py
    image.py
    logging.py
    labels.py

The legacy localinferenceapi.py remains as a shim that just attaches routers.


Part C — Incremental Fuzz/Smoke Validation Plan (Required)
----------------------------------------------------------
We replace the “week of logging” approach with *incremental fuzzing*.
Every change batch must pass fuzz tests *before moving on*.

Principles:
1) Each batch is small (single feature or a small file extraction).
2) After every batch, run a targeted fuzz/smoke test suite.
3) Keep a rolling “minimal test pack” that executes in ~1–3 minutes.
4) If tests fail, revert or fix immediately (no piling up broken work).

Test tiers:
  Tier 0 (smoke): request/response validation on core endpoints
  Tier 1 (fuzz lite): randomized but bounded inputs for prepass & calibration
  Tier 2 (fuzz deep): optional full pipeline with real sample images

We run Tier 0 + Tier 1 on *every batch*.
Tier 2 is run after larger milestones.


Part D — Fuzz Pack Specification
-------------------------------
Create a minimal, deterministic test pack with:
- 2–4 small sample images
- a tiny labelmap
- 1 detector config, 1 classifier config, 1 SAM3 config
- 1 glossary with 3–5 classes

Fuzz steps:
1) Start API
2) Validate /datasets, /models, /glossary endpoints
3) Run a single prepass with tiny max_images
4) Run calibration with cached prepass
5) Run captioning (single image)
6) Run detector run with both full-frame + windowed
7) Confirm results are schema-valid and non-empty

All fuzz runs should:
- enforce deterministic random seeds
- run under tight timeouts (fail fast)
- produce a single structured JSON summary for regression comparison


Part E — Safe Refactor Order (each step fuzzed)
-----------------------------------------------
1) Extract utils/ (image, labels, io) → run Tier 0/1 fuzz
2) Extract prepass services → fuzz
3) Extract calibration services → fuzz
4) Extract detector registry + inference → fuzz
5) Extract classifier registry + inference → fuzz
6) Extract SAM3 + Qwen helpers → fuzz
7) Replace route handlers with api/* routers → fuzz
8) Remove unused legacy code → fuzz


Part F — Regression Rules
-------------------------
We do not proceed if:
- Any fuzz test fails
- Any output schema changes unexpectedly
- Any calibration metrics regresses by >2% absolute without explanation

If regression occurs:
- Identify which batch caused it
- Fix immediately or roll back


Outcome
-------
By the end of this sequence:
- localinferenceapi.py is reduced to a router loader
- all core logic lives in services/
- unused code is removed with confidence
- fuzz tests keep behavior stable throughout


Atomic Task List (Executable Roadmap)
-------------------------------------
These are the exact, itemized tasks to perform in order. Each item is a
stand‑alone atomic change with required fuzz/smoke validation afterward.

Testing/Validation Rule for Every Step
- After each step (or step batch), run Tier‑0 + Tier‑1 fuzz.
- Record a regression summary JSON and diff against baseline.
- If any schema changes or metrics regress >2% without explanation: stop, fix,
  re‑run.
- Every step must include a “safety check” line in notes: what could break,
  and how we verified it did not.

Prep / Baseline
1. Create a minimal deterministic “fuzz pack” dataset (2–4 images + tiny
   labelmap + sample glossary) in a new folder under tests/fixtures/.
   - Include: labelmap.txt, glossary.json, 2–4 images, optional labels
   - Keep image sizes small to reduce GPU cost
   - Store a small manifest.json with hashes for images + labelmap + glossary
   - Validate manifest hashes at test start
2. Create Tier‑0 smoke test script:
   - Start/reuse API
   - Hit /health + /datasets + /models + /glossaries
   - Validate schemas and required fields
   - Assert non‑empty fields: datasets=[], models=[], glossaries=[]
   - Ensure API returns 200 and JSON parses under strict schema
3. Create Tier‑1 fuzz‑lite script (must cover all options):
   - Prepass: detectors only (YOLO+RF‑DETR), SAM3 text only, SAM3 similarity only
   - Prepass: windowed SAM3 text ON + similarity ON
   - Prepass: windowed OFF (baseline)
   - Calibration: MLP + XGB on same cache
   - Caption: full‑frame + windowed captioning
   - Detector: full‑frame + SAHI
   - Classifier: batch scoring with full probability vector
   - Ensure both detector models are requested in the same run
   - Ensure glossary hash + text are recorded in cache meta
4. Add regression summary output (JSON):
   - For each step: detections count, class distribution, cache count
   - For calibration: precision/recall/F1
   - Track hashes for glossary/labelmap/recipe
   - Track “pipeline_version” and “config_hash”
   - Track counts per source (yolo/rfdetr/sam3_text/sam3_similarity)
5. Add a runner script:
   - Executes Tier‑0 then Tier‑1
   - Fixed seeds; emits baseline diff report
   - Optional “fast mode” to skip heavy SAM3/Qwen
   - Exits non‑zero if any diff in required fields

Stage 1 — Utilities Extraction
6. Identify image/label/io helper functions in localinferenceapi.py.
   - Create a mapping table (function name → new module)
7. Move image helpers to utils/image.py (preserve signature).
   - Add unit tests for any non‑trivial helper (resize, tiling, bbox conversion)
8. Move label helpers to utils/labels.py (preserve labelmap behavior).
   - Add tests for labelmap parsing and label alignment
9. Move IO helpers to utils/io.py (no path changes).
   - Add tests for JSON/YAML loading (with json5 fallback)
10. Update imports to use utils/ modules.
11. Run Tier‑0 + Tier‑1 fuzz (check no change in output schema).

Validation Backlog (run when GPUs are free)
------------------------------------------
- Run tools/run_fuzz_fast.sh (Tier‑0 + Tier‑1 in skip‑GPU mode)
- Run tools/run_fuzz_fast.sh with SKIP_GPU=0 (full Tier‑1)
- Confirm prepass endpoint responds with same schema (no missing fields)
- Confirm caption endpoint returns full + windowed outputs
- Spot‑check: cluster label counts + overlay summaries unchanged after helper extraction
- Spot‑check: get_tile_context tile_cluster_list + caption_hint unchanged after tile_context refactor
- Spot‑check: prepass window generation (sam3_text + similarity) unchanged after prepass_windows refactor
- Spot‑check: similarity expansion counts unchanged after prepass_similarity refactor
- Spot‑check: background_classes derived from classifier head unchanged after classifier_utils refactor
- Spot‑check: labelmap+glossary loading unchanged after datasets labelmap_meta refactor
- Spot‑check: detector payload fields (bbox_2d/bbox_yolo) unchanged after coords det_payload refactor
- Spot‑check: YOLO/RF‑DETR extract outputs unchanged after services/detectors move
- Spot‑check: detector image cache resolution unchanged after services/detectors move
- Spot‑check: YOLO device arg/p2 scale helpers unchanged after services/detectors move
- Spot‑check: RF‑DETR variant/checkpoint/log helpers unchanged after services/detectors move
- Spot‑check: RF‑DETR metric sanitize + aug policy unchanged after services/detectors move
- Spot‑check: RF‑DETR augmentation install/restore unchanged after services/detectors move
- Spot‑check: RF‑DETR checkpoint epoch helper unchanged after services/detectors move
- Spot‑check: RF‑DETR training monitor loop unchanged after services/detectors move
- Spot‑check: YOLO training helpers unchanged after services/detectors move
- Spot‑check: checkpoint optimizer stripping unchanged after services/detectors move
- Spot‑check: YOLO/RF‑DETR labelmap loaders unchanged after services/detectors move
- Spot‑check: RF‑DETR dataset prep/remap unchanged after services/detectors move
- Spot‑check: base64 image decode unchanged after utils/image move
- Spot‑check: COCO info/write/ensure helpers unchanged after utils/coco move
- Spot‑check: path_is_within_root helper unchanged after utils/io move
- Spot‑check: classifier resolve/load wrappers unchanged after refactor import cleanup
- Spot‑check: validate_cuda_device_ids helper unchanged after utils/gpu move
- Spot‑check: COCO validity/segmentation helpers unchanged after utils/coco move
- Spot‑check: YOLO label image lookup unchanged after utils/image move
- Spot‑check: COCO image path/label relpath unchanged after utils/image move
- Spot‑check: Qwen JSONL label extraction unchanged after datasets move
- Spot‑check: YOLO labelmap discovery unchanged after datasets move
- Spot‑check: localinferenceapi import cleanup doesn't alter endpoint behavior (start API, hit /health)
- Spot‑check: glossary library load remains intact after helper pruning
- Spot‑check: prepass grid usage summaries unchanged after grid helper pruning
- Spot‑check: calibration prompt/candidate endpoints still work after metrics helper pruning
- Spot‑check: classifier head tuning endpoints still work after classifier helper pruning
- Spot‑check: YOLO→COCO conversion unchanged after datasets move
- Spot‑check: Qwen→COCO conversion unchanged after datasets move
- Spot‑check: COCO→YOLO conversion unchanged after datasets move
- Spot‑check: SAM3 dataset meta resolution unchanged after datasets move
- Spot‑check: COCO index loader unchanged after datasets move
- Spot‑check: prepass recipe import/export unchanged after dead wrapper cleanup
- Spot‑check: COCO path helpers still wired via services after wrapper cleanup
- Spot‑check: labelmap meta helpers wired to datasets impls unchanged after wrapper cleanup
- Spot‑check: agent mining cache/meta roots still enforced after helper cleanup
- Spot‑check: prepass endpoints still route through deep prepass after legacy wrapper cleanup
- Spot‑check: COCO info/segmentation helpers still invoked via services after wrapper cleanup
- Spot‑check: calibration prompt expansion still uses services/qwen after prompt wrapper cleanup
- Spot‑check: Qwen dataset metadata persist still invoked via services/datasets after wrapper cleanup
- Spot‑check: agent mining CLIP backbone still loads via services/clip_runtime after impl cleanup (no missing references)
- Spot‑check: hard-negative replay export UI still behaves (no missing refs) after calibration_metrics cleanup
- Spot‑check: RF‑DETR training rejects invalid device IDs after GPU validation wiring
- Spot‑check: YOLO data.yaml writer unchanged after services/detectors move
- Spot‑check: YOLO variant YAML + detect module helpers unchanged after services/detectors move
- Spot‑check: RF‑DETR DDP worker unchanged after services/detectors move
- Spot‑check: head‑graft audit + force‑stop unchanged after services/detector_jobs move
- Spot‑check: free-port helper unchanged after utils/network move
- Spot‑check: stable hash helper unchanged after utils/hashing move
- Spot‑check: SAM3 synonym expansion outputs unchanged after sam3_synonyms refactor
- Spot‑check: cluster handle mapping unchanged after cluster_handles refactor
- Spot‑check: classifier default selection + labelmap matching unchanged after classifier_select refactor
- Spot‑check: grid tool usage tracking unchanged after prepass_grid usage refactor
- Spot‑check: overlay crop bbox selection unchanged after overlay_tools refactor
- Spot‑check: classifier batch sizing + proba batching unchanged after classifier_batch refactor
- Spot‑check: detector NMS merge outputs unchanged after detector_merge refactor
- Spot‑check: prepass cache meta includes glossary text + hash (new caching safety)
- Spot‑check: prepass cache writes glossary.json alongside prepass.meta.json
- Spot‑check: glossary normalization + labelmap entry normalization unchanged after utils/glossary + utils/labels move
- Spot‑check: labelmap mismatch guard unchanged after utils/labels move
- Spot‑check: window bbox normalization unchanged after utils/coords move
- Spot‑check: recipe meta read/write unchanged after services/prepass_recipes move
- Spot‑check: dataset glossary + qwen labelmap loaders unchanged after services/datasets move
- Spot‑check: qwen dataset signature helpers unchanged after services/datasets move
- Spot‑check: dataset metadata helpers unchanged after services/datasets move
- Spot‑check: qwen dataset metadata load/persist unchanged after services/datasets move
- Spot‑check: sam3 dataset metadata load/persist unchanged after services/datasets move
- Spot‑check: dataset caption counting unchanged after services/datasets move
- Spot‑check: dataset listing unchanged after services/datasets move
- Spot‑check: qwen caption label helpers unchanged after services/qwen move
- Spot‑check: qwen window position helper unchanged after services/qwen move
- Spot‑check: dir_size_bytes unchanged after utils/io move
- Spot‑check: glossary library load/normalize unchanged after services/glossary_library move
- Spot‑check: recipe threshold normalization unchanged after services/prepass_config move
- Spot‑check: SAM3 availability guard unchanged after services/prepass_config move
- Spot‑check: calibration sample/hash/link helpers unchanged after services/calibration_helpers move
- Spot‑check: calibration image listing unchanged after services/calibration_helpers move
- Spot‑check: calibration atomic write unchanged after services/calibration_helpers move
- Spot‑check: calibration job update helper unchanged after services/calibration_helpers move
- Spot‑check: calibration image cache token unchanged after services/calibration_helpers move
- Spot‑check: SAM3 prompt variants unchanged after services/sam3_synonyms move
- Spot‑check: SAM3 cache clearing unchanged after services/sam3_runtime move
- Spot‑check: SAM3 device resolution unchanged after services/sam3_runtime move
- Spot‑check: SAM3 runtime reset unchanged after services/sam3_runtime move
- Spot‑check: SAM3 backend selection unchanged after services/sam3_runtime move
- Spot‑check: SAM3 text runtime load unchanged after services/sam3_runtime move
- Spot‑check: Qwen runtime reset unchanged after services/qwen_runtime move
- Spot‑check: Qwen runtime unload unchanged after services/qwen_runtime move
- Spot‑check: Qwen caption cache eviction unchanged after services/qwen_runtime move
- Spot‑check: Qwen caption runtime loader unchanged after services/qwen_runtime move
- Spot‑check: Qwen variant resolver unchanged after services/qwen move
- Spot‑check: Qwen model suffix handling unchanged after services/qwen move
- Spot‑check: Qwen load error formatting unchanged after services/qwen move
- Spot‑check: Qwen device selection unchanged after services/qwen_runtime move
- Spot‑check: Qwen prompt config get/set unchanged after services/qwen move
- Spot‑check: Qwen prompt rendering unchanged after services/qwen move
- Spot‑check: Qwen JSON block parsing unchanged after services/qwen move
- Spot‑check: Qwen coordinate scaling helpers unchanged after utils/coords move
- Spot‑check: inference runtime unloads unchanged after services/runtime_unload move
- Spot‑check: training runtime prepare/finalize unchanged after services/runtime_unload move
- Spot‑check: DINOv3 device resolution unchanged after services/dinov3_runtime move
- Spot‑check: CLIP backbone suspend/resume unchanged after services/clip_runtime move
- Spot‑check: CLIP mining backbone load unchanged after services/clip_runtime move
- Spot‑check: classifier backbone resume unchanged after services/classifier_runtime move
- Spot‑check: context store/chunk behavior unchanged after services/context_store move
- Spot‑check: overlay view cell/full payloads unchanged after services/overlay_views move
- Spot‑check: tile context payloads unchanged after services/tile_context move
- Spot‑check: readable logging (prepass.readable) unchanged after services/readable move
- Spot‑check: similarity exemplar selection unchanged after services/prepass move
- Spot‑check: deep prepass cleanup unchanged after services/prepass move
- Spot‑check: deep prepass part A unchanged after services/prepass move
- Spot‑check: deep prepass wrapper unchanged after services/prepass move
- Spot‑check: deep prepass caption unchanged after services/prepass move
- Spot‑check: legacy prepass wrapper unchanged after services/prepass move
- Spot‑check: calibration prepass worker unchanged after services/calibration_helpers move
- Spot‑check: qwen caption helper outputs unchanged after services/qwen move
- Spot‑check: qwen text helper outputs unchanged after services/qwen move
- Spot‑check: calibration orchestration unchanged after services/calibration move
- Spot‑check: detector inference outputs unchanged after services/detectors move
- Spot‑check: detector runtime caching unchanged after services/detectors move
- Spot‑check: detector infer state setters unchanged after services/detectors move
- Spot‑check: detector active/default configs unchanged after services/detectors move
- Spot‑check: classifier review + batching outputs unchanged after services/classifier move
- Spot‑check: agent recipe list/delete endpoints unchanged after services/prepass_recipes move
- Spot‑check: agent recipe persist/load/zip endpoints unchanged after services/prepass_recipes move
- Spot‑check: agent recipe import endpoints unchanged after services/prepass_recipes move
- Spot‑check: agent cascade endpoints unchanged after services/agent_cascades move
- Spot‑check: agent cascade import endpoints unchanged after services/agent_cascades move
- Spot‑check: prepass recipe list/delete/import/export endpoints unchanged after services/prepass_recipes move
- Spot‑check: prepass recipe asset export bundle unchanged after services/prepass_recipes move
- Spot‑check: prepass recipe export endpoint unchanged after services/prepass_recipes move
- Spot‑check: prepass recipe CRUD endpoints unchanged after services/prepass_recipes move
- Spot‑check: prompt helper preset endpoints unchanged after services/prompt_helper_presets move
- Spot‑check: prompt helper job serialization unchanged after services/prompt_helper move
- Spot‑check: segmentation job serialization unchanged after services/segmentation move
- Spot‑check: segmentation job log/update unchanged after services/segmentation move
- Spot‑check: qwen training job serialization unchanged after services/qwen_jobs move
- Spot‑check: qwen training GET logging unchanged after services/qwen_jobs move
- Spot‑check: qwen training job log/update unchanged after services/qwen_jobs move
- Spot‑check: qwen training metric append unchanged after services/qwen_jobs move
- Spot‑check: qwen metric coercion unchanged after services/qwen_jobs move
- Spot‑check: qwen metric summary unchanged after services/qwen_jobs move
- Spot‑check: clip training job serialization unchanged after services/classifier_jobs move
- Spot‑check: clip training job logging/update unchanged after services/classifier_jobs move
- Spot‑check: clip training job metric append unchanged after services/classifier_jobs move
- Spot‑check: sam3 training job serialization unchanged after services/sam3_jobs move
- Spot‑check: sam3 training job log/update unchanged after services/sam3_jobs move
- Spot‑check: sam3 run listing unchanged after services/sam3_runs move
- Spot‑check: detector job serialization unchanged after services/detector_jobs move
- Spot‑check: detector job log/update unchanged after services/detector_jobs move
- Spot‑check: head‑graft job log/update unchanged after services/detector_jobs move
- Spot‑check: dataset artifact purge unchanged after services/datasets move
- Spot‑check: Qwen label collection unchanged after services/datasets move
- Spot‑check: YOLO labelmap discovery unchanged after services/datasets move

Stage 2 — Prepass Service Extraction
12. Create services/prepass.py; move prepass pipeline (detectors + SAM3 + dedupe).
13. Create services/prepass_config.py for defaults + validation.
14. Ensure prepass config includes all toggles (windowed, thresholds, detectors).
15. Update API handlers to call services/prepass.py.
16. Run Tier‑0 + Tier‑1 fuzz:
    - Verify cached prepass reuse
    - Verify glossary text is stored in cache meta
    - Verify windowed/non‑windowed match expected counts
    - Verify detector full‑frame + SAHI both included
   - Verify settings from UI propagate to prepass config

Stage 2.5 — Qwen helpers (captioning + prompt expansion)
17. Create services/qwen.py and move Qwen caption helpers + prompt expansion glue.
18. Keep legacy wrappers in localinferenceapi.py to preserve API shape.
19. Run Tier‑0 + Tier‑1 fuzz:
    - Verify captioning full + windowed flows
    - Verify synonym expansion prompt and output parsing
    - Verify labelmap/glossary handling unchanged

   Stage 2 progress notes
   - Moved tile context helpers (cluster ownership, tile caption hints, tile payload)
     into services/tile_context.py and updated get_tile_context to use them.
   - Moved prepass window helpers (sam3_text + similarity windows, exemplar filter)
     into services/prepass_windows.py; moved _slice_image_sahi to utils/image.py and
     _resolve_agent_bbox_xyxy to utils/coords.py.
   - Moved similarity expansion helpers into services/prepass_similarity.py and
     provenance helpers into services/prepass_provenance.py.
   - Moved background class helper into utils/classifier_utils.py.
   - Moved labelmap/glossary loader into services/datasets.py with local wrapper.
   - Moved detection payload + YOLO norm helpers into utils/coords.py.
   - Moved SAM3 synonym generation + cache into services/sam3_synonyms.py.
   - Moved cluster handle/index helpers into services/cluster_handles.py.
   - Moved classifier selection helpers into services/classifier_select.py.
   - Moved grid tool usage helpers into services/prepass_grid.py.
   - Moved overlay base/crop helpers into services/overlay_tools.py.
   - Moved classifier batching helpers into services/classifier_batch.py.
   - Moved detector NMS merge helpers into services/detector_merge.py.
   - Moved detector parameter clamping helpers into services/detector_params.py.
   - Moved readable logger helper into services/readable.py.
   - Moved SAM3 availability guard into services/prepass_config.py.
   - Moved calibration helpers (sample/hash/link) into services/calibration_helpers.py.
   - Moved calibration image listing into services/calibration_helpers.py.
   - Moved calibration atomic record writer into services/calibration_helpers.py.
   - Moved calibration update helper into services/calibration_helpers.py.
   - Moved calibration cache-image helper into services/calibration_helpers.py.
   - Moved SAM3 prompt variant helper into services/sam3_synonyms.py.
   - Moved agent context store/chunk wrappers into services/context_store.py.
   - Moved overlay view helpers into services/overlay_views.py.
   - Moved tile context payload builder into services/tile_context.py.
   - Moved similarity exemplar selector into services/prepass.py.
   - Moved deep prepass cleanup into services/prepass.py.
   - Moved deep prepass part A into services/prepass.py.
   - Moved deep prepass wrapper into services/prepass.py.
   - Moved deep prepass caption into services/prepass.py.
   - Moved legacy prepass wrapper into services/prepass.py.
   - Moved calibration prepass worker into services/calibration_helpers.py.
   - Moved Qwen caption helper utilities into services/qwen.py.
   - Moved Qwen text prompt helpers into services/qwen.py.
   - Moved calibration job orchestration into services/calibration.py.
   - Moved detector inference tool into services/detectors.py.
   - Moved detector runtime loaders into services/detectors.py.
   - Moved detector active/default config helpers into services/detectors.py.
   - Moved classifier review/batching helpers into services/classifier.py.
   - Moved classifier path resolve + head load + proba helpers into services/classifier.py.
   - Moved classifier keep-mask helper into services/classifier.py.
   - Moved classifier normalize-embeddings resolver into services/classifier.py.
   - Moved active head normalize resolver into services/classifier.py.
   - Moved CLIP head artifact save/load into services/classifier.py.
   - Moved clip head background guard settings helper into services/classifier.py.
   - Moved clip model inference helper into services/classifier.py.
   - Moved clip auto-predict label/details helpers into services/classifier.py.
   - Moved clip head scoring helper into services/classifier.py.
   - Moved clip head sweep/tuning helpers into services/classifier.py.
   - Moved CLIP dataset validation helpers into services/classifier.py.
   - Moved CLIP labelmap/classifier listing helpers into services/classifier.py.
   - Moved prompt evaluation helpers into services/calibration_metrics.py.
   - Moved prompt expansion helpers into services/qwen.py.
   - Moved seed-threshold + step-selection helpers into services/calibration_metrics.py.
   - Moved agent recipe delete/list helpers into services/prepass_recipes.py.
   - Moved agent recipe persist/load/zip helpers into services/prepass_recipes.py.
   - Moved agent recipe import helpers into services/prepass_recipes.py.
   - Moved agent cascade persistence helpers into services/agent_cascades.py.
   - Moved agent cascade import helpers into services/agent_cascades.py.
   - Moved prepass recipe directory/list/manifest helpers into services/prepass_recipes.py.
   - Moved prepass recipe asset collection helper into services/prepass_recipes.py.
   - Moved prepass recipe import helper into services/prepass_recipes.py.
   - Moved prepass recipe export helper into services/prepass_recipes.py.
   - Moved prepass recipe CRUD helpers into services/prepass_recipes.py.
   - Moved prompt helper preset helpers into services/prompt_helper_presets.py.
   - Moved prompt helper job serializer into services/prompt_helper.py.
   - Moved dataset artifact purge helper into services/datasets.py.
   - Moved Qwen label collection helpers into services/datasets.py.
   - Moved YOLO labelmap discovery helper into services/datasets.py.

   Helpers to move in Stage 2 (do not forget):
   - Completed: _normalize_labelmap_glossary (utils/glossary)
   - Completed: _normalize_window_xyxy (utils/coords)
   - Completed: _normalize_labelmap_entries (utils/labels)
   - Completed: _write_prepass_recipe_meta / _load_prepass_recipe_meta (services/prepass_recipes)
   - Completed: _load_dataset_glossary / _load_qwen_labelmap (services/datasets)
   - Completed: _load_glossary_library / _normalize_glossary_name (services/glossary_library)
   - Completed: _normalize_recipe_thresholds (services/prepass_config)

Stage 3 — Calibration Service Extraction
17. Create services/calibration.py; move job orchestration.
18. Create services/calibration_metrics.py for eval logic.
19. Ensure MLP and XGB paths are both wired + selectable.
20. Update API handlers to call services/calibration.py.
21. Run Tier‑0 + Tier‑1 fuzz:
    - Verify both calibration models run
    - Verify metric schema consistent
    - Verify dedupe/eval IoU settings applied correctly
    - Verify classifier required guard works
    - Verify missing detectors fail fast

Stage 4 — Detector Registry + Inference
22. Create services/detectors.py for model loading + inference.
23. Create services/detector_registry.py for active model selection.
24. Ensure detector selection supports multiple models per run.
25. Update detector endpoints to call services/detectors.py.
26. Run Tier‑0 + Tier‑1 fuzz:
    - Verify full‑frame + SAHI outputs
    - Verify missing weights error handling
    - Verify RF‑DETR labelmap mismatch throws error
    - Verify concurrency guard prevents overlapping inference

Stage 5 — Classifier Registry + Inference
27. Create services/classifier.py for batch inference.
28. Create services/classifier_registry.py for active model selection.
29. Ensure full per‑class probability vectors are returned.
30. Update classifier endpoints to call services/classifier.py.
31. Run Tier‑0 + Tier‑1 fuzz:
    - Verify batch inference works
    - Verify score vectors preserved
    - Verify GPU OOM fallback reduces batch size

Stage 6 — SAM3 + Qwen Helpers
32. Create services/sam3.py (text + similarity + windowed helpers).
33. Create services/qwen.py (captioning + glossary expansion).
34. Ensure SAM3 text + similarity use image‑first cache order.
35. Ensure Qwen prompt expansion is capped by per‑class config.
36. Update endpoints to call services/sam3.py + services/qwen.py.
37. Run Tier‑0 + Tier‑1 fuzz:
    - Verify windowed SAM3 text/similarity
    - Verify glossary expansion prompt consistency
    - Verify captioning runs full + windowed
    - Verify caption prompt avoids labelmap tokens

Stage 7 — Router Split
38. Create api/prepass.py with APIRouter and move prepass routes.
39. Create api/calibration.py and move calibration routes.
40. Create api/detectors.py, api/classifiers.py, api/qwen.py, api/sam3.py.
41. Update localinferenceapi.py to include routers only.
42. Run Tier‑0 + Tier‑1 fuzz:
    - Confirm endpoint paths unchanged
    - Confirm OpenAPI routes intact
    - Confirm UI still loads all tabs (manual smoke check)

Stage 8 — Dead Code Removal
43. Generate a dead‑code report (AST + route inventory).
44. Remove a small batch of unused functions (20–40).
45. Run Tier‑0 + Tier‑1 fuzz tests.
46. Repeat steps 43–45 until no high‑confidence dead code remains.
    - Keep a log of removed functions for audit
    - Candidate list to verify:
      - ClipDatasetUploadJob + CLIP_DATASET_JOBS/LOCK (unreferenced)
      - QwenDatasetUploadJob + QWEN_DATASET_JOBS/LOCK (unreferenced)

Stage 9 — Final Verification
47. Run Tier‑2 fuzz (full pipeline on 2–4 images).
48. Run end‑to‑end benchmark on 10‑image subset.
49. Compare regression summary to baseline (<=2% variance).
50. Update Readme with new architecture diagram and migration notes.
    - Include “what moved where” mapping table

Stage 10 — Cleanup + Docs
51. Add module docstrings to services/ + api/ files.
52. Update developer docs to reference new module locations.
53. Remove any vestigial import shims or compatibility hacks.
54. Final Tier‑0 + Tier‑1 fuzz run.
    - Confirm all scripts reference new module paths

Progress Log
------------
- Stage 3: moved seed‑stage prompt subset + step config helpers into
  services/calibration_metrics.py and converted local wrappers.
- Stage 3: moved step recipe builder + clip prefilter crop sampler into
  services/calibration_metrics.py and converted local wrappers.
- Stage 3: moved step normalization helper into services/calibration_metrics.py
  and converted local wrapper.
- Stage 3: moved CLIP prompt prefilter helper into services/calibration_metrics.py
  and converted local wrapper.
- Stage 1: moved YOLO layout detection helpers into services/datasets.py and
  converted local wrappers.
- Stage 1: moved dataset resolution helpers into services/datasets.py and
  converted local wrappers.
- Stage 1: moved dataset integrity helpers into services/datasets.py and
  converted local wrappers.
- Stage 1: moved glossary library upsert/delete helpers into
  services/glossary_library.py and converted local wrappers.
- Stage 1: moved YOLO/RF‑DETR training dataset resolution into
  services/datasets.py and converted local wrappers.
- Stage 1: moved agent recipe parsing/validation helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 1: moved YOLO run-id + directory signature helpers into utils/io.py
  and converted local wrappers.
- Stage 1: moved labelmap/dataset signature helpers into services/datasets.py
  and converted local wrappers.
- Stage 4: moved YOLO/RF‑DETR run metadata + metrics helpers into
  services/detectors.py and converted local wrappers.
- Stage 4: moved YOLO/RF‑DETR run listing helpers into services/detectors.py
  and converted local wrappers.
- Stage 4: moved YOLO/RF‑DETR extract helpers into services/detectors.py and
  converted local wrappers.
- Stage 4: moved detector image resolver into services/detectors.py and
  converted local wrapper.
- Stage 4: moved YOLO device arg + p2 scale helpers into services/detectors.py
  and converted local wrappers.
- Stage 4: moved RF‑DETR variant/checkpoint/log helpers into services/detectors.py
  and converted local wrappers.
- Stage 4: moved RF‑DETR metric sanitize + aug policy helpers into
  services/detectors.py and converted local wrappers.
- Stage 4: moved RF‑DETR augmentation install/restore helpers into
  services/detectors.py and converted local wrappers.
- Stage 4: moved RF‑DETR checkpoint epoch helper into services/detectors.py
  and converted local wrapper.
- Stage 4: moved RF‑DETR monitor training loop into services/detectors.py and
  converted local wrapper.
- Stage 4: moved YOLO augment + CSV parse + training monitor helpers into
  services/detectors.py and converted local wrappers.
- Stage 4: moved checkpoint optimizer stripping helper into
  services/detectors.py and converted local wrapper.
- Stage 4: moved YOLO/RF‑DETR labelmap loaders into services/detectors.py and
  converted local wrappers.
- Stage 4: moved RF‑DETR dataset prep + remap helpers into services/detectors.py
  and converted local wrappers.
- Stage 4: moved YOLO data.yaml writer into services/detectors.py and converted
  local wrapper.
- Stage 4: moved YOLO model source + variant YAML helpers + detect module helpers
  into services/detectors.py and converted local wrappers.
- Stage 4: moved RF‑DETR DDP worker into services/detectors.py and converted
  local wrapper.
- Stage 1: moved free-port helper into utils/network.py and converted wrapper.
- Stage 1: moved stable hash helper into utils/hashing.py and converted wrapper.
- Stage 1: moved base64 image decode helper into utils/image.py and converted
  wrapper.
- Stage 1: moved COCO info/write/ensure helpers into utils/coco.py and converted
  local wrappers.
- Stage 1: moved path_is_within_root helper into utils/io.py and converted
  local wrapper.
- Stage 2: restored classifier resolve/load wrappers after classifier service move.
- Stage 1: moved validate_cuda_device_ids helper into utils/gpu.py and converted
  local wrapper.
- Stage 1: moved COCO validity/segmentation helpers into utils/coco.py and
  converted local wrappers.
- Stage 1: moved YOLO label image lookup helper into utils/image.py and
  converted local wrapper.
- Stage 1: moved COCO image path + label relpath helpers into utils/image.py and
  converted local wrappers.
- Stage 1: moved Qwen JSONL label extraction helpers into services/datasets.py
  and converted local wrappers.
- Stage 1: moved YOLO labelmap discovery helper into services/datasets.py and
  converted local wrapper.
- Stage 1: moved YOLO→COCO conversion into services/datasets.py and converted
  local wrapper.
- Stage 1: moved Qwen→COCO conversion into services/datasets.py and converted
  local wrapper.
- Stage 1: moved COCO→YOLO conversion into services/datasets.py and converted
  local wrapper.
- Stage 1: moved SAM3 dataset meta resolver into services/datasets.py and
  converted local wrapper.
- Stage 1: moved COCO index loader into services/datasets.py and converted
  local wrapper.
- Stage 8: removed unused prepass recipe wrapper helpers (meta/assets/sha256).
- Stage 8: removed unused COCO path wrapper helpers.
- Stage 8: removed unused labelmap dataset wrapper helpers (Qwen labels +
  YOLO labelmap discovery + payload extraction).
- Stage 8: removed unused agent mining cache/meta dir helpers.
- Stage 8: removed unused agent prepass helper wrappers (run_prepass,
  finalize_detections, set_active_detections).
- Stage 8: removed unused misc wrappers (agent classifier review, COCO info
  helpers, CLIP mining loader wrapper, prompt self-filter, calibration helpers,
  Qwen prompt config setter, dataset signature wrapper, label-id validator,
  pruning helpers).
- Stage 8: removed unused Qwen dataset metadata persist wrapper.
- Stage 8: removed unused service impls (legacy agent prepass, clip mining loader,
  calibration midpoints/replay, qwen prompt self-filter, dataset signature helpers).
- Stage 8: re‑wired GPU device ID validation in RF‑DETR training (uses utils/gpu).
- Stage 8: removed unused prepass recipe import hooks in localinferenceapi.py.
- Stage 8: removed unused glossary library imports in localinferenceapi.py.
- Stage 8: pruned unused imports in localinferenceapi.py (prepass/grid/coords/overlay/llm/readable/classifier/calibration_metrics/qwen).
- Stage 8: removed unused helpers in services/prepass + services/prepass_grid + services/datasets + services/prepass_recipes + services/qwen + services/readable.
- Stage 8: removed unused helpers in utils (coords remap, image size, io atomic/json writers, parsing device IDs, overlay data URI, trace sanitize messages) and deleted utils/text.py + utils/llm.py.
- Stage 8: removed unused helpers in services/classifier + services/calibration_metrics + services/readable (post-clean).
- Stage 2: moved head‑graft audit + force‑stop helpers into
  services/detector_jobs.py and converted local wrappers.
- Stage 3: moved hard‑negative export helper into services/calibration_metrics.py
  and converted local wrapper.
- Stage 2: moved agent recipe delete/list helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved agent recipe persist/load/zip helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved agent recipe import helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved agent cascade helpers into
  services/agent_cascades.py and converted local wrappers.
- Stage 1: moved labelmap mismatch helpers into utils/labels.py and updated
  local wrappers.
- Stage 1: moved SAM3 run listing helpers into services/sam3_runs.py and
  updated local wrappers.
- Stage 1: moved detector infer state setters into services/detectors.py and
  updated local wrappers.
- Stage 1: moved SAM3 cache clearing helper into services/sam3_runtime.py and
  updated local wrapper.
- Stage 1: moved SAM3 device resolution helpers into services/sam3_runtime.py
  and updated local wrappers.
- Stage 1: moved SAM3 runtime reset helper into services/sam3_runtime.py and
  updated local wrapper.
- Stage 1: moved SAM3 backend selector into services/sam3_runtime.py and
  updated local wrapper.
- Stage 1: moved SAM3 text runtime loader into services/sam3_runtime.py and
  updated local wrapper.
- Stage 1: moved Qwen runtime reset/unload helpers into services/qwen_runtime.py
  and updated local wrappers.
- Stage 1: moved Qwen caption cache eviction helper into services/qwen_runtime.py
  and updated local wrapper.
- Stage 1: moved Qwen variant resolver into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen model suffix handler into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen load error formatter into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen device resolver into services/qwen_runtime.py and updated local wrapper.
- Stage 1: moved Qwen prompt config get/set into services/qwen.py and updated local wrappers.
- Stage 1: moved Qwen prompt renderer into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen JSON block parsing into services/qwen.py and updated local wrapper.
- Stage 1: moved Qwen coordinate scaling helpers into utils/coords.py and updated local usage.
- Stage 1: moved inference runtime unload helpers into services/runtime_unload.py
  and updated local wrappers.
- Stage 1: moved training runtime prepare/finalize helpers into
  services/runtime_unload.py and updated local wrappers.
- Stage 1: moved DINOv3 device resolver into services/dinov3_runtime.py and
  updated local wrapper.
- Stage 1: moved CLIP backbone suspend/resume helpers into services/clip_runtime.py
  and updated local wrappers.
- Stage 1: moved CLIP mining backbone loader into services/clip_runtime.py and
  updated local wrapper.
- Stage 1: moved classifier backbone resume helper into services/classifier_runtime.py
  and updated local wrapper.
- Stage 2: moved agent cascade import helpers into
  services/agent_cascades.py and converted local wrappers.
- Stage 2: moved prepass recipe directory/list/manifest helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved prepass recipe asset collection helper into
  services/prepass_recipes.py and converted local wrapper.
- Stage 2: moved prepass recipe import helper into
  services/prepass_recipes.py and converted local wrapper.
- Stage 2: moved prepass recipe export helper into
  services/prepass_recipes.py and converted local wrapper.
- Stage 2: moved prepass recipe CRUD helpers into
  services/prepass_recipes.py and converted local wrappers.
- Stage 2: moved prompt helper preset helpers into
  services/prompt_helper_presets.py and converted local wrappers.
- Stage 2: moved prompt helper job serializer into
  services/prompt_helper.py and converted local wrapper.
- Stage 2: moved dataset artifact purge helper into
  services/datasets.py and converted local wrapper.
- Stage 2: moved Qwen label collection helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved YOLO labelmap discovery helper into
  services/datasets.py and converted local wrapper.
- Stage 2: moved Qwen dataset signature helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved dataset metadata helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved Qwen dataset metadata helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved SAM3 dataset metadata helpers into
  services/datasets.py and converted local wrappers.
- Stage 2: moved dataset image/caption counters into
  services/datasets.py and converted local wrappers.
- Stage 2: moved dataset list builder into
  services/datasets.py and converted local wrapper.
- Stage 2.5: moved caption label helpers (allowed labels + degenerate check) into
  services/qwen.py and converted local wrappers.
- Stage 2.5: moved window positioning helper into
  services/qwen.py and converted local wrapper.
- Stage 1: moved dir_size_bytes into utils/io and converted local wrapper.
- Stage 2: moved segmentation job serializer into
  services/segmentation.py and converted local wrapper.
- Stage 2: moved segmentation job log/update helpers into
  services/segmentation.py and converted local wrapper.
- Stage 2: moved Qwen training job serializer into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved Qwen training GET logger into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved Qwen training job log/update helpers into
  services/qwen_jobs.py and converted local wrappers.
- Stage 2: moved Qwen training metric append helper into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved Qwen metric coercion helper into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved Qwen metric summary helper into
  services/qwen_jobs.py and converted local wrapper.
- Stage 2: moved CLIP training job serializer into
  services/classifier_jobs.py and converted local wrapper.
- Stage 2: moved CLIP training job log/update helpers into
  services/classifier_jobs.py and converted local wrappers.
- Stage 2: moved CLIP training job metric append into
  services/classifier_jobs.py and converted local wrapper.
- Stage 2: moved SAM3 training job serializer into
  services/sam3_jobs.py and converted local wrapper.
- Stage 2: moved SAM3 training job log/update helpers into
  services/sam3_jobs.py and converted local wrappers.
- Stage 2: moved YOLO/RF‑DETR/head‑graft job serializers into
  services/detector_jobs.py and converted local wrappers.
- Stage 2: moved YOLO/RF‑DETR job log/update helpers into
  services/detector_jobs.py and converted local wrappers.
- Stage 2: moved head‑graft job log/update helpers into
  services/detector_jobs.py and converted local wrappers.
- Stage 2.5: moved Qwen caption runtime loader into
  services/qwen_runtime.py and converted local wrapper.
